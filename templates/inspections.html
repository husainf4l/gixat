{% extends 'dashboard_layout.html' %}
{% load static %}

{% block title %}Inspections - Gixat Auto Repair{% endblock %}

{% block page_subtitle %}
<h1 class="text-xl lg:text-2xl font-semibold text-gray-800">Vehicle Inspections</h1>
<p class="text-sm text-gray-600 mt-1">Manage vehicle condition checks and quality inspections</p>
{% endblock %}

{% block top_actions %}
<div class="flex items-center space-x-3">
    <button onclick="showNewInspectionModal()" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        New Inspection
    </button>
    <button onclick="showTemplatesModal()" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors duration-200">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Templates
    </button>
</div>
{% endblock %}

{% block dashboard_content %}

<!-- Status Filters -->
<div class="bg-white rounded-lg shadow-sm p-4 mb-6">
    <div class="flex flex-wrap items-center gap-2">
        <span class="text-sm font-medium text-gray-700">Filter by Status:</span>
        <button onclick="filterByStatus('all')" class="px-3 py-1.5 text-xs font-medium rounded-full bg-blue-100 text-blue-800 status-filter" data-status="all">All</button>
        <button onclick="filterByStatus('new')" class="px-3 py-1.5 text-xs font-medium rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 status-filter" data-status="new">New</button>
        <button onclick="filterByStatus('in_progress')" class="px-3 py-1.5 text-xs font-medium rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 status-filter" data-status="in_progress">In Progress</button>
        <button onclick="filterByStatus('completed')" class="px-3 py-1.5 text-xs font-medium rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 status-filter" data-status="completed">Completed</button>
        <button onclick="filterByStatus('waiting_approval')" class="px-3 py-1.5 text-xs font-medium rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 status-filter" data-status="waiting_approval">Waiting Approval</button>
    </div>
</div>

<!-- Inspections Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- Inspection Card 1 - New -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200 inspection-card" data-status="new">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <span class="text-sm font-semibold text-gray-900">#INS-1001</span>
                <span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">New</span>
            </div>

            <div class="space-y-3 mb-4">
                <div>
                    <div class="text-xs text-gray-500">Vehicle</div>
                    <div class="text-sm font-medium text-gray-900">2022 Honda Civic - XYZ-789</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Client</div>
                    <div class="text-sm font-medium text-gray-900">Jane Smith</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Inspector</div>
                    <div class="text-sm font-medium text-gray-900">Tom Wilson</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Scheduled</div>
                    <div class="text-sm font-medium text-gray-900">Oct 6, 2025 10:00 AM</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Template</div>
                    <div class="text-sm font-medium text-gray-900">Pre-Service Inspection</div>
                </div>
            </div>

            <div class="flex items-center space-x-2 pt-4 border-t border-gray-200">
                <button onclick="viewInspection('INS-1001')" class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">
                    View Details
                </button>
                <button onclick="startInspection('INS-1001')" class="px-3 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors">
                    Start
                </button>
            </div>
        </div>
    </div>

    <!-- Inspection Card 2 - In Progress -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200 inspection-card" data-status="in_progress">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <span class="text-sm font-semibold text-gray-900">#INS-1002</span>
                <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">In Progress</span>
            </div>

            <div class="space-y-3 mb-4">
                <div>
                    <div class="text-xs text-gray-500">Vehicle</div>
                    <div class="text-sm font-medium text-gray-900">2023 Ford F-150 - ABC-456</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Client</div>
                    <div class="text-sm font-medium text-gray-900">Robert Johnson</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Inspector</div>
                    <div class="text-sm font-medium text-gray-900">Sarah Davis</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Progress</div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: 65%"></div>
                    </div>
                    <div class="text-xs text-gray-600 mt-1">18 of 28 items checked</div>
                </div>
            </div>

            <div class="flex items-center space-x-2 pt-4 border-t border-gray-200">
                <button onclick="continueInspection('INS-1002')" class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">
                    Continue
                </button>
                <button onclick="viewInspection('INS-1002')" class="px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors">
                    View
                </button>
            </div>
        </div>
    </div>

    <!-- Inspection Card 3 - Completed -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200 inspection-card" data-status="completed">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <span class="text-sm font-semibold text-gray-900">#INS-1003</span>
                <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Completed</span>
            </div>

            <div class="space-y-3 mb-4">
                <div>
                    <div class="text-xs text-gray-500">Vehicle</div>
                    <div class="text-sm font-medium text-gray-900">2021 Tesla Model 3 - TES-123</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Client</div>
                    <div class="text-sm font-medium text-gray-900">Michael Brown</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Inspector</div>
                    <div class="text-sm font-medium text-gray-900">Mike Johnson</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Completed</div>
                    <div class="text-sm font-medium text-gray-900">Oct 5, 2025 3:45 PM</div>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-xs text-gray-500">Issues Found:</span>
                    <span class="px-2 py-0.5 text-xs font-medium bg-red-100 text-red-800 rounded-full">3 Critical</span>
                    <span class="px-2 py-0.5 text-xs font-medium bg-orange-100 text-orange-800 rounded-full">5 Minor</span>
                </div>
            </div>

            <div class="flex items-center space-x-2 pt-4 border-t border-gray-200">
                <button onclick="viewInspection('INS-1003')" class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">
                    View Report
                </button>
                <button onclick="downloadPDF('INS-1003')" class="px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors" title="Download PDF">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Inspection Card 4 - Waiting Approval -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200 inspection-card" data-status="waiting_approval">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <span class="text-sm font-semibold text-gray-900">#INS-1004</span>
                <span class="px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 rounded-full">Waiting Approval</span>
            </div>

            <div class="space-y-3 mb-4">
                <div>
                    <div class="text-xs text-gray-500">Vehicle</div>
                    <div class="text-sm font-medium text-gray-900">2020 Chevrolet Silverado - CHV-789</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Client</div>
                    <div class="text-sm font-medium text-gray-900">David Wilson</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Inspector</div>
                    <div class="text-sm font-medium text-gray-900">Tom Wilson</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Completed</div>
                    <div class="text-sm font-medium text-gray-900">Oct 5, 2025 11:20 AM</div>
                </div>
                <div class="flex items-center space-x-2">
                    <svg class="w-4 h-4 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="text-xs text-gray-600">Awaiting customer signature</span>
                </div>
            </div>

            <div class="flex items-center space-x-2 pt-4 border-t border-gray-200">
                <button onclick="viewInspection('INS-1004')" class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">
                    Review
                </button>
                <button onclick="requestSignature('INS-1004')" class="px-3 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700 transition-colors">
                    Request Sign
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Status filtering
let currentStatus = 'all';

function filterByStatus(status) {
    currentStatus = status;

    document.querySelectorAll('.status-filter').forEach(btn => {
        btn.classList.remove('bg-blue-100', 'text-blue-800');
        btn.classList.add('bg-gray-100', 'text-gray-700');
    });

    event.target.classList.add('bg-blue-100', 'text-blue-800');
    event.target.classList.remove('bg-gray-100', 'text-gray-700');

    const inspectionCards = document.querySelectorAll('.inspection-card');
    inspectionCards.forEach(card => {
        if (status === 'all' || card.dataset.status === status) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

// New Inspection Modal
function showNewInspectionModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-semibold text-gray-900">Create New Inspection</h2>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Vehicle *</label>
                        <select required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Choose a vehicle...</option>
                            <option value="1">2022 Honda Civic - XYZ-789 (Jane Smith)</option>
                            <option value="2">2023 Ford F-150 - ABC-456 (Robert Johnson)</option>
                            <option value="3">2021 Tesla Model 3 - TES-123 (Michael Brown)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Assign Inspector *</label>
                        <select required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Choose inspector...</option>
                            <option value="1">Mike Johnson</option>
                            <option value="2">Sarah Davis</option>
                            <option value="3">Tom Wilson</option>
                            <option value="4">Emily Rodriguez</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Inspection Template *</label>
                        <select required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select template...</option>
                            <option value="pre-service">Pre-Service Inspection (28 items)</option>
                            <option value="post-repair">Post-Repair Quality Check (15 items)</option>
                            <option value="annual">Annual Safety Inspection (42 items)</option>
                            <option value="quick">Quick Visual Inspection (10 items)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Scheduled Date & Time *</label>
                        <input type="datetime-local" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Link to Repair Session (Optional)</label>
                    <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">No linked session</option>
                        <option value="1">Session #12345 - Brake Replacement</option>
                        <option value="2">Session #12346 - Oil Change</option>
                        <option value="3">Session #12347 - Engine Diagnostic</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Additional notes or special instructions..."></textarea>
                </div>

                <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Create Inspection
                    </button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

// Templates Modal
function showTemplatesModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900">Inspection Templates</h2>
                    <p class="text-sm text-gray-600 mt-1">Manage customizable inspection checklists</p>
                </div>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <button onclick="showCreateTemplateModal()" class="px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors">
                        + Create New Template
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Template Card 1 -->
                    <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">Pre-Service Inspection</h3>
                            <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">Active</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">Comprehensive inspection before service begins</p>
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">Checklist Items:</span>
                                <span class="font-medium text-gray-900">28</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">Categories:</span>
                                <span class="font-medium text-gray-900">Exterior, Interior, Engine, Safety</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">Used:</span>
                                <span class="font-medium text-gray-900">156 times</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="editTemplate('1')" class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700">
                                Edit
                            </button>
                            <button onclick="duplicateTemplate('1')" class="px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200">
                                Duplicate
                            </button>
                        </div>
                    </div>

                    <!-- Template Card 2 -->
                    <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">Post-Repair QC</h3>
                            <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">Active</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">Quality check after repairs are completed</p>
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">Checklist Items:</span>
                                <span class="font-medium text-gray-900">15</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">Categories:</span>
                                <span class="font-medium text-gray-900">Work Quality, Test Drive</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">Used:</span>
                                <span class="font-medium text-gray-900">243 times</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="editTemplate('2')" class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700">
                                Edit
                            </button>
                            <button onclick="duplicateTemplate('2')" class="px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200">
                                Duplicate
                            </button>
                        </div>
                    </div>

                    <!-- Template Card 3 -->
                    <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">Annual Safety Inspection</h3>
                            <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">Active</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">State-required annual safety inspection</p>
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">Checklist Items:</span>
                                <span class="font-medium text-gray-900">42</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">Categories:</span>
                                <span class="font-medium text-gray-900">All Systems</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">Used:</span>
                                <span class="font-medium text-gray-900">89 times</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="editTemplate('3')" class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700">
                                Edit
                            </button>
                            <button onclick="duplicateTemplate('3')" class="px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200">
                                Duplicate
                            </button>
                        </div>
                    </div>

                    <!-- Template Card 4 -->
                    <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">Quick Visual Inspection</h3>
                            <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">Active</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">Fast visual check for drop-offs</p>
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">Checklist Items:</span>
                                <span class="font-medium text-gray-900">10</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">Categories:</span>
                                <span class="font-medium text-gray-900">Exterior, Interior</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">Used:</span>
                                <span class="font-medium text-gray-900">421 times</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="editTemplate('4')" class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700">
                                Edit
                            </button>
                            <button onclick="duplicateTemplate('4')" class="px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200">
                                Duplicate
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-end mt-6 pt-4 border-t border-gray-200">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// View Inspection Modal with full checklist, photos, and signature
function viewInspection(inspectionId) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900">Inspection ${inspectionId}</h2>
                    <p class="text-sm text-gray-600 mt-1">2021 Tesla Model 3 - TES-123 | Michael Brown</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="downloadInspectionPDF('${inspectionId}')" class="px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">
                        <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Download PDF
                    </button>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <!-- Vehicle Condition Checklist -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Vehicle Condition Checklist</h3>
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <div class="flex items-center justify-between p-3 bg-white rounded border border-gray-200">
                            <div class="flex items-center space-x-3">
                                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-sm font-medium text-gray-900">Exterior Body Condition</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <select class="text-xs border border-gray-300 rounded px-2 py-1" onchange="updateItemCondition('${inspectionId}', '1', this.value)">
                                    <option value="excellent" selected>Excellent</option>
                                    <option value="good">Good</option>
                                    <option value="fair">Fair</option>
                                    <option value="poor">Poor</option>
                                    <option value="critical">Critical</option>
                                </select>
                                <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Pass</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white rounded border border-gray-200">
                            <div class="flex items-center space-x-3">
                                <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-sm font-medium text-gray-900">Tire Tread Depth (Front Left: 2/32")</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <select class="text-xs border border-gray-300 rounded px-2 py-1" onchange="updateItemCondition('${inspectionId}', '2', this.value)">
                                    <option value="excellent">Excellent</option>
                                    <option value="good">Good</option>
                                    <option value="fair">Fair</option>
                                    <option value="poor">Poor</option>
                                    <option value="critical" selected>Critical</option>
                                </select>
                                <span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Critical</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white rounded border border-gray-200">
                            <div class="flex items-center space-x-3">
                                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-sm font-medium text-gray-900">Brake Fluid Level</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <select class="text-xs border border-gray-300 rounded px-2 py-1" onchange="updateItemCondition('${inspectionId}', '3', this.value)">
                                    <option value="excellent">Excellent</option>
                                    <option value="good" selected>Good</option>
                                    <option value="fair">Fair</option>
                                    <option value="poor">Poor</option>
                                    <option value="critical">Critical</option>
                                </select>
                                <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Pass</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white rounded border border-gray-200">
                            <div class="flex items-center space-x-3">
                                <svg class="w-5 h-5 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-sm font-medium text-gray-900">Windshield - Small chip in upper right</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <select class="text-xs border border-gray-300 rounded px-2 py-1" onchange="updateItemCondition('${inspectionId}', '4', this.value)">
                                    <option value="excellent">Excellent</option>
                                    <option value="good">Good</option>
                                    <option value="fair" selected>Fair</option>
                                    <option value="poor">Poor</option>
                                    <option value="critical">Critical</option>
                                </select>
                                <span class="px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 rounded-full">Minor</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Photo Attachments -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Photo & Video Attachments</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="relative group">
                            <div class="aspect-square bg-gray-200 rounded-lg flex items-center justify-center">
                                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-opacity rounded-lg flex items-center justify-center">
                                <button class="opacity-0 group-hover:opacity-100 px-3 py-1 bg-white text-sm font-medium rounded">View</button>
                            </div>
                            <div class="mt-1 text-xs text-gray-600">Front tire damage</div>
                        </div>
                        <div class="relative group">
                            <div class="aspect-square bg-gray-200 rounded-lg flex items-center justify-center">
                                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-opacity rounded-lg flex items-center justify-center">
                                <button class="opacity-0 group-hover:opacity-100 px-3 py-1 bg-white text-sm font-medium rounded">View</button>
                            </div>
                            <div class="mt-1 text-xs text-gray-600">Windshield chip</div>
                        </div>
                        <div class="relative group">
                            <div class="aspect-square bg-gray-200 rounded-lg flex items-center justify-center">
                                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-opacity rounded-lg flex items-center justify-center">
                                <button class="opacity-0 group-hover:opacity-100 px-3 py-1 bg-white text-sm font-medium rounded">Play</button>
                            </div>
                            <div class="mt-1 text-xs text-gray-600">Test drive (2:15)</div>
                        </div>
                        <button class="aspect-square border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center hover:border-blue-500 hover:bg-blue-50 transition-colors">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            <span class="text-xs text-gray-600 mt-1">Add Photo/Video</span>
                        </button>
                    </div>
                </div>

                <!-- Digital Signature -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Digital Signature</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Inspector Signature -->
                        <div class="border-2 border-gray-200 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 mb-3">Inspector Signature</h4>
                            <div class="bg-gray-50 border border-gray-300 rounded h-24 flex items-center justify-center mb-3">
                                <div class="text-center">
                                    <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                    </svg>
                                    <button onclick="openSignaturePad('${inspectionId}', 'inspector')" class="px-3 py-1 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700">
                                        Sign Here
                                    </button>
                                </div>
                            </div>
                            <div class="text-xs text-gray-600">
                                <p>Signed by: Tom Wilson</p>
                                <p>Date: Oct 5, 2025 2:30 PM</p>
                            </div>
                        </div>

                        <!-- Client Signature -->
                        <div class="border-2 border-gray-200 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 mb-3">Client Signature</h4>
                            <div class="bg-gray-50 border border-gray-300 rounded h-24 flex items-center justify-center mb-3">
                                <div class="text-center">
                                    <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                    </svg>
                                    <button onclick="requestClientSignature('${inspectionId}')" class="px-3 py-1 bg-orange-600 text-white text-sm font-medium rounded hover:bg-orange-700">
                                        Request Signature
                                    </button>
                                </div>
                            </div>
                            <div class="text-xs text-gray-600">
                                <p>Status: Awaiting client signature</p>
                                <p>An email has been sent to the client</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Link to Repair Session -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Linked Repair Session</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-900">Session #12345 - Brake Replacement</p>
                                <p class="text-xs text-gray-600">Scheduled for Oct 8, 2025 | Status: Scheduled</p>
                            </div>
                            <button onclick="linkToRepair('${inspectionId}')" class="px-3 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors">
                                Link to Session
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        Close
                    </button>
                    <div class="flex items-center space-x-3">
                        <button onclick="saveInspection('${inspectionId}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Save Changes
                        </button>
                        <button onclick="completeInspection('${inspectionId}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            Complete Inspection
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function startInspection(inspectionId) {
    alert(`Starting inspection ${inspectionId} - Opening checklist interface...`);
}

function continueInspection(inspectionId) {
    alert(`Continuing inspection ${inspectionId} - Resuming from item 19/28...`);
}

function downloadPDF(inspectionId) {
    alert(`Downloading PDF report for inspection ${inspectionId}...`);
}

function requestSignature(inspectionId) {
    alert(`Sending signature request email for inspection ${inspectionId}...`);
}

function linkToRepair(inspectionId) {
    alert(`Linking inspection ${inspectionId} findings to a new repair session...`);
}

// New functions for enhanced inspection features
function updateItemCondition(inspectionId, itemId, condition) {
    // AJAX call to update inspection item condition
    fetch(`/inspections/${inspectionId}/items/${itemId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ condition: condition })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Item condition updated successfully');
        } else {
            alert('Error updating item condition');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating item condition');
    });
}

function downloadInspectionPDF(inspectionId) {
    // Trigger PDF download
    window.open(`/inspections/${inspectionId}/pdf/`, '_blank');
}

function openSignaturePad(inspectionId, signatureType) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-semibold text-gray-900">Digital Signature</h2>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-4">Please sign below using your mouse or touch device:</p>
                    <canvas id="signatureCanvas" class="border border-gray-300 rounded w-full h-48 bg-white"></canvas>
                </div>
                <div class="flex items-center justify-between">
                    <button onclick="clearSignature()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                        Clear
                    </button>
                    <div class="flex items-center space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                            Cancel
                        </button>
                        <button onclick="saveSignature('${inspectionId}', '${signatureType}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Save Signature
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    // Initialize signature pad
    initSignaturePad();
}

function initSignaturePad() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    // Set canvas size
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;

    // Clear canvas
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Drawing functions
    function startDrawing(e) {
        isDrawing = true;
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
    }

    function draw(e) {
        if (!isDrawing) return;
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
    }

    function stopDrawing() {
        isDrawing = false;
    }

    // Set drawing style
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    // Event listeners
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // Touch events for mobile
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        startDrawing({ offsetX: x, offsetY: y });
    });

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        draw({ offsetX: x, offsetY: y });
    });

    canvas.addEventListener('touchend', stopDrawing);
}

function clearSignature() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
}

function saveSignature(inspectionId, signatureType) {
    const canvas = document.getElementById('signatureCanvas');
    const signatureData = canvas.toDataURL('image/png');

    // AJAX call to save signature
    fetch(`/inspections/${inspectionId}/signature/${signatureType}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ signature: signatureData })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Signature saved successfully');
            document.querySelector('.fixed').remove();
            // Refresh the inspection view
            location.reload();
        } else {
            alert('Error saving signature');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving signature');
    });
}

function requestClientSignature(inspectionId) {
    // AJAX call to request client signature
    fetch(`/inspections/${inspectionId}/request-signature/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Signature request sent to client');
        } else {
            alert('Error sending signature request');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error sending signature request');
    });
}

function saveInspection(inspectionId) {
    alert(`Saving inspection ${inspectionId} changes...`);
    // AJAX call to save inspection changes would go here
}

function completeInspection(inspectionId) {
    if (confirm('Are you sure you want to complete this inspection? This action cannot be undone.')) {
        // AJAX call to complete inspection
        fetch(`/inspections/${inspectionId}/complete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Inspection completed successfully');
                location.reload();
            } else {
                alert('Error completing inspection');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error completing inspection');
        });
    }
}

function linkToRepair(inspectionId) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-semibold text-gray-900">Link to Repair Session</h2>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Repair Session</label>
                    <select id="repairSessionSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Choose a repair session...</option>
                        <option value="12345">Session #12345 - Brake Replacement</option>
                        <option value="12346">Session #12346 - Oil Change</option>
                        <option value="12347">Session #12347 - Engine Diagnostic</option>
                    </select>
                </div>
                <div class="flex items-center justify-end space-x-3">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                        Cancel
                    </button>
                    <button onclick="confirmLinkToRepair('${inspectionId}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        Link Session
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function confirmLinkToRepair(inspectionId) {
    const sessionId = document.getElementById('repairSessionSelect').value;
    if (!sessionId) {
        alert('Please select a repair session');
        return;
    }

    // AJAX call to link inspection to repair session
    fetch(`/inspections/${inspectionId}/link-session/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ session_id: sessionId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Inspection linked to repair session successfully');
            document.querySelector('.fixed').remove();
            location.reload();
        } else {
            alert('Error linking inspection to repair session');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error linking inspection to repair session');
    });
}

function getCSRFToken() {
    // Get CSRF token from cookie or meta tag
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfToken ? csrfToken.value : '';
}

// Template management functions
function showCreateTemplateModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-semibold text-gray-900">Create New Template</h2>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form onsubmit="createTemplate(event)" class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Template Name *</label>
                    <input type="text" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Pre-Service Inspection">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea name="description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Brief description of this inspection template..."></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Checklist Items</label>
                    <div id="checklistItems" class="space-y-3">
                        <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                            <input type="text" placeholder="Item description" class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <select class="px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="exterior">Exterior</option>
                                <option value="interior">Interior</option>
                                <option value="engine">Engine</option>
                                <option value="safety">Safety</option>
                                <option value="other">Other</option>
                            </select>
                            <button type="button" onclick="removeChecklistItem(this)" class="text-red-600 hover:text-red-800">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="button" onclick="addChecklistItem()" class="mt-3 px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">
                        + Add Item
                    </button>
                </div>

                <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        Create Template
                    </button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

function addChecklistItem() {
    const container = document.getElementById('checklistItems');
    const itemDiv = document.createElement('div');
    itemDiv.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg';
    itemDiv.innerHTML = `
        <input type="text" placeholder="Item description" class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <select class="px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="exterior">Exterior</option>
            <option value="interior">Interior</option>
            <option value="engine">Engine</option>
            <option value="safety">Safety</option>
            <option value="other">Other</option>
        </select>
        <button type="button" onclick="removeChecklistItem(this)" class="text-red-600 hover:text-red-800">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
        </button>
    `;
    container.appendChild(itemDiv);
}

function removeChecklistItem(button) {
    button.closest('.flex').remove();
}

function createTemplate(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const name = formData.get('name');
    const description = formData.get('description');

    // Collect checklist items
    const items = [];
    const itemElements = document.querySelectorAll('#checklistItems .flex');
    itemElements.forEach(item => {
        const description = item.querySelector('input').value;
        const category = item.querySelector('select').value;
        if (description.trim()) {
            items.push({ description, category });
        }
    });

    // AJAX call to create template
    fetch('/inspections/templates/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            name: name,
            description: description,
            template_items: items
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Template created successfully');
            document.querySelector('.fixed').remove();
            // Refresh templates modal
            document.querySelector('.fixed').remove();
            showTemplatesModal();
        } else {
            alert('Error creating template: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating template');
    });
}

function editTemplate(templateId) {
    // AJAX call to get template data and show edit modal
    fetch(`/inspections/templates/${templateId}/`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showEditTemplateModal(data.template);
        } else {
            alert('Error loading template');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading template');
    });
}

function duplicateTemplate(templateId) {
    if (confirm('Are you sure you want to duplicate this template?')) {
        // AJAX call to duplicate template
        fetch(`/inspections/templates/${templateId}/duplicate/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Template duplicated successfully');
                // Refresh templates modal
                document.querySelector('.fixed').remove();
                showTemplatesModal();
            } else {
                alert('Error duplicating template');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error duplicating template');
        });
    }
}

function showEditTemplateModal(template) {
    // Similar to create modal but pre-populated with template data
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-semibold text-gray-900">Edit Template</h2>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form onsubmit="updateTemplate(event, '${template.id}')" class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Template Name *</label>
                    <input type="text" name="name" required value="${template.name}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea name="description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">${template.description || ''}</textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Checklist Items</label>
                    <div id="checklistItems" class="space-y-3">
                        ${template.template_items ? template.template_items.map(item => `
                            <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                <input type="text" value="${item.description}" class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <select class="px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="exterior" ${item.category === 'exterior' ? 'selected' : ''}>Exterior</option>
                                    <option value="interior" ${item.category === 'interior' ? 'selected' : ''}>Interior</option>
                                    <option value="engine" ${item.category === 'engine' ? 'selected' : ''}>Engine</option>
                                    <option value="safety" ${item.category === 'safety' ? 'selected' : ''}>Safety</option>
                                    <option value="other" ${item.category === 'other' ? 'selected' : ''}>Other</option>
                                </select>
                                <button type="button" onclick="removeChecklistItem(this)" class="text-red-600 hover:text-red-800">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        `).join('') : ''}
                    </div>
                    <button type="button" onclick="addChecklistItem()" class="mt-3 px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">
                        + Add Item
                    </button>
                </div>

                <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        Update Template
                    </button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

function updateTemplate(event, templateId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const name = formData.get('name');
    const description = formData.get('description');

    // Collect checklist items
    const items = [];
    const itemElements = document.querySelectorAll('#checklistItems .flex');
    itemElements.forEach(item => {
        const description = item.querySelector('input').value;
        const category = item.querySelector('select').value;
        if (description.trim()) {
            items.push({ description, category });
        }
    });

    // AJAX call to update template
    fetch(`/inspections/templates/${templateId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            name: name,
            description: description,
            template_items: items
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Template updated successfully');
            document.querySelector('.fixed').remove();
            // Refresh templates modal
            document.querySelector('.fixed').remove();
            showTemplatesModal();
        } else {
            alert('Error updating template: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating template');
    });
}
</script>

{% endblock %}
