@page "/Sessions/{id:guid}/Reports/Initial"
@model Gixat.Web.Pages.Sessions.Reports.InitialModel
@using Gixat.Modules.Sessions.Enums
@{
    ViewData["Title"] = $"Initial Report - Session #{Model.Session.SessionNumber}";
    Layout = "_AppLayout";
}

<div class="space-y-6 max-w-4xl mx-auto">
    <!-- Header with Print Button -->
    <div class="flex items-center justify-between print:hidden">
        <div class="flex items-center space-x-4">
            <a href="/Sessions/Details/@Model.Session.Id" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            <div>
                <h1 class="text-2xl font-semibold text-gray-900">Initial Inspection Report</h1>
                <p class="text-sm text-gray-500">Session #@Model.Session.SessionNumber</p>
            </div>
        </div>
        <button onclick="window.print()" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
            </svg>
            Print Report
        </button>
    </div>

    <!-- Report Content -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 print:shadow-none print:border-0">
        <!-- Report Header -->
        <div class="border-b border-gray-200 pb-6 mb-6">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Vehicle Initial Assessment Report</h2>
                    <p class="text-sm text-gray-500 mt-1">Generated on @DateTime.Now.ToString("MMMM dd, yyyy HH:mm")</p>
                </div>
                <div class="text-right">
                    <p class="text-sm font-medium text-gray-900">Session #@Model.Session.SessionNumber</p>
                    <p class="text-sm text-gray-500">@Model.Session.CheckInAt.ToString("MMM dd, yyyy")</p>
                </div>
            </div>
        </div>

        <!-- Client & Vehicle Info -->
        <div class="grid grid-cols-2 gap-8 mb-8">
            <div>
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Client Information</h3>
                <div class="space-y-2">
                    <p class="text-base font-medium text-gray-900">@Model.Client?.FirstName @Model.Client?.LastName</p>
                    @if (!string.IsNullOrEmpty(Model.Client?.Phone))
                    {
                        <p class="text-sm text-gray-600">üìû @Model.Client.Phone</p>
                    }
                    @if (!string.IsNullOrEmpty(Model.Client?.Email))
                    {
                        <p class="text-sm text-gray-600">‚úâÔ∏è @Model.Client.Email</p>
                    }
                </div>
            </div>
            <div>
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Vehicle Information</h3>
                <div class="space-y-2">
                    <p class="text-base font-medium text-gray-900">@Model.Vehicle?.Year @Model.Vehicle?.Make @Model.Vehicle?.Model</p>
                    @if (!string.IsNullOrEmpty(Model.Vehicle?.LicensePlate))
                    {
                        <p class="text-sm text-gray-600">Plate: @Model.Vehicle.LicensePlate</p>
                    }
                    @if (!string.IsNullOrEmpty(Model.Vehicle?.Vin))
                    {
                        <p class="text-sm text-gray-600">VIN: @Model.Vehicle.Vin</p>
                    }
                    @if (Model.Session.MileageIn.HasValue)
                    {
                        <p class="text-sm text-gray-600">Mileage: @Model.Session.MileageIn.Value.ToString("N0") km</p>
                    }
                </div>
            </div>
        </div>

        <!-- Customer Request -->
        @if (Model.CustomerRequest != null)
        {
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <span class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                        </svg>
                    </span>
                    Customer Request
                </h3>
                <div class="bg-gray-50 rounded-xl p-4 space-y-3">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Concerns</p>
                        <p class="text-gray-900">@(Model.CustomerRequest.CustomerConcerns ?? "No specific concerns noted")</p>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.CustomerRequest.RequestedServices))
                    {
                        <div>
                            <p class="text-sm font-medium text-gray-500">Requested Services</p>
                            <p class="text-gray-900">@Model.CustomerRequest.RequestedServices</p>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.CustomerRequest.Description))
                    {
                        <div>
                            <p class="text-sm font-medium text-gray-500">Additional Details</p>
                            <p class="text-gray-900">@Model.CustomerRequest.Description</p>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Inspection Findings -->
        @if (Model.Inspection != null)
        {
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <span class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                    </span>
                    Inspection Findings
                </h3>
                
                <!-- Condition Summary -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                    @{
                        var conditions = new[] {
                            ("Engine", Model.Inspection.EngineCondition),
                            ("Transmission", Model.Inspection.TransmissionCondition),
                            ("Brakes", Model.Inspection.BrakeCondition),
                            ("Suspension", Model.Inspection.SuspensionCondition),
                            ("Tires", Model.Inspection.TireCondition),
                            ("Electrical", Model.Inspection.ElectricalCondition),
                            ("Exterior", Model.Inspection.ExteriorCondition),
                            ("Interior", Model.Inspection.InteriorCondition)
                        };
                    }
                    @foreach (var (name, condition) in conditions)
                    {
                        if (!string.IsNullOrEmpty(condition))
                        {
                            var conditionColor = condition.ToLower() switch
                            {
                                "good" or "excellent" => "bg-green-100 text-green-800 border-green-200",
                                "fair" or "average" => "bg-yellow-100 text-yellow-800 border-yellow-200",
                                "poor" or "bad" or "needs attention" => "bg-red-100 text-red-800 border-red-200",
                                _ => "bg-gray-100 text-gray-800 border-gray-200"
                            };
                            <div class="p-3 rounded-lg border @conditionColor">
                                <p class="text-xs font-medium opacity-75">@name</p>
                                <p class="text-sm font-semibold">@condition</p>
                            </div>
                        }
                    }
                </div>

                <!-- Inspection Items -->
                @if (Model.Inspection.Items?.Any() == true)
                {
                    <div class="bg-gray-50 rounded-xl p-4">
                        <p class="text-sm font-medium text-gray-500 mb-3">Inspection Items</p>
                        <div class="space-y-2">
                            @foreach (var item in Model.Inspection.Items.OrderBy(i => i.SortOrder))
                            {
                                var priorityColor = item.Priority switch
                                {
                                    Priority.Urgent => "text-red-600",
                                    Priority.High => "text-orange-600",
                                    Priority.Normal => "text-yellow-600",
                                    _ => "text-gray-600"
                                };
                                var requiresAttention = item.RequiresAttention ? "‚ö†Ô∏è" : "‚úì";
                                
                                <div class="flex items-start gap-2 py-2 border-b border-gray-200 last:border-0">
                                    <span class="text-lg">@requiresAttention</span>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-900">@item.ItemName</p>
                                        @if (!string.IsNullOrEmpty(item.Description))
                                        {
                                            <p class="text-sm text-gray-600">@item.Description</p>
                                        }
                                        @if (!string.IsNullOrEmpty(item.Notes))
                                        {
                                            <p class="text-sm text-gray-500 italic">@item.Notes</p>
                                        }
                                    </div>
                                    <div class="text-right">
                                        <span class="text-xs font-medium @priorityColor">@item.Priority</span>
                                        @if (!string.IsNullOrEmpty(item.Condition))
                                        {
                                            <p class="text-xs text-gray-500">@item.Condition</p>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.Inspection.Findings))
                {
                    <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                        <p class="text-sm font-medium text-yellow-800 mb-1">Key Findings</p>
                        <p class="text-yellow-900">@Model.Inspection.Findings</p>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.Inspection.Recommendations))
                {
                    <div class="mt-4 bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <p class="text-sm font-medium text-blue-800 mb-1">Recommendations</p>
                        <p class="text-blue-900">@Model.Inspection.Recommendations</p>
                    </div>
                }
            </div>
        }

        <!-- Test Drive Results -->
        @if (Model.TestDrive != null)
        {
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <span class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </span>
                    Test Drive Results
                </h3>
                
                @if (Model.TestDrive.MileageStart.HasValue && Model.TestDrive.MileageEnd.HasValue)
                {
                    <div class="flex gap-4 mb-4">
                        <div class="bg-gray-50 rounded-lg px-4 py-2">
                            <p class="text-xs text-gray-500">Distance</p>
                            <p class="text-lg font-semibold text-gray-900">@((Model.TestDrive.MileageEnd.Value - Model.TestDrive.MileageStart.Value).ToString("N0")) km</p>
                        </div>
                        @if (Model.TestDrive.StartedAt.HasValue && Model.TestDrive.CompletedAt.HasValue)
                        {
                            <div class="bg-gray-50 rounded-lg px-4 py-2">
                                <p class="text-xs text-gray-500">Duration</p>
                                <p class="text-lg font-semibold text-gray-900">@((Model.TestDrive.CompletedAt.Value - Model.TestDrive.StartedAt.Value).TotalMinutes.ToString("N0")) min</p>
                            </div>
                        }
                    </div>
                }

                <!-- Performance Observations -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    @{
                        var performances = new[] {
                            ("Engine", Model.TestDrive.EnginePerformance),
                            ("Transmission", Model.TestDrive.TransmissionPerformance),
                            ("Brakes", Model.TestDrive.BrakePerformance),
                            ("Steering", Model.TestDrive.SteeringPerformance),
                            ("Suspension", Model.TestDrive.SuspensionPerformance),
                            ("A/C", Model.TestDrive.AcPerformance)
                        };
                    }
                    @foreach (var (name, performance) in performances)
                    {
                        if (!string.IsNullOrEmpty(performance))
                        {
                            <div class="bg-gray-50 rounded-lg p-3">
                                <p class="text-xs font-medium text-gray-500">@name</p>
                                <p class="text-sm text-gray-900">@performance</p>
                            </div>
                        }
                    }
                </div>

                <!-- Observations -->
                @{
                    var observations = new[] {
                        ("Noise Observations", Model.TestDrive.NoiseObservations),
                        ("Vibration Observations", Model.TestDrive.VibrationObservations),
                        ("Electrical Observations", Model.TestDrive.ElectricalObservations)
                    };
                }
                @foreach (var (title, observation) in observations)
                {
                    if (!string.IsNullOrEmpty(observation))
                    {
                        <div class="bg-gray-50 rounded-lg p-3 mb-2">
                            <p class="text-xs font-medium text-gray-500">@title</p>
                            <p class="text-sm text-gray-900">@observation</p>
                        </div>
                    }
                }

                @if (!string.IsNullOrEmpty(Model.TestDrive.Findings))
                {
                    <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                        <p class="text-sm font-medium text-yellow-800 mb-1">Test Drive Findings</p>
                        <p class="text-yellow-900">@Model.TestDrive.Findings</p>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.TestDrive.Recommendations))
                {
                    <div class="mt-4 bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <p class="text-sm font-medium text-blue-800 mb-1">Recommendations</p>
                        <p class="text-blue-900">@Model.TestDrive.Recommendations</p>
                    </div>
                }
            </div>
        }

        <!-- Summary -->
        <div class="border-t border-gray-200 pt-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Summary</h3>
            <div class="bg-gray-50 rounded-xl p-4">
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-2xl font-bold text-blue-600">@(Model.CustomerRequest != null ? "‚úì" : "‚Äî")</p>
                        <p class="text-sm text-gray-500">Customer Request</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-orange-600">@(Model.Inspection != null ? "‚úì" : "‚Äî")</p>
                        <p class="text-sm text-gray-500">Inspection</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-green-600">@(Model.TestDrive != null ? "‚úì" : "‚Äî")</p>
                        <p class="text-sm text-gray-500">Test Drive</p>
                    </div>
                </div>
                
                @if (Model.Inspection?.Items?.Any(i => i.RequiresAttention) == true)
                {
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-sm font-medium text-red-600 mb-2">‚ö†Ô∏è Items Requiring Attention: @Model.Inspection.Items.Count(i => i.RequiresAttention)</p>
                    </div>
                }
            </div>
        </div>

        <!-- Signature Area (for print) -->
        <div class="mt-8 pt-6 border-t border-gray-200 print:block hidden">
            <div class="grid grid-cols-2 gap-8">
                <div>
                    <p class="text-sm text-gray-500 mb-8">Customer Signature</p>
                    <div class="border-b border-gray-400 w-full"></div>
                    <p class="text-xs text-gray-400 mt-1">Date: _______________</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 mb-8">Service Advisor Signature</p>
                    <div class="border-b border-gray-400 w-full"></div>
                    <p class="text-xs text-gray-400 mt-1">Date: _______________</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Button (screen only) -->
    <div class="flex justify-start print:hidden">
        <a href="/Sessions/Details/@Model.Session.Id" class="px-4 py-2 text-gray-600 hover:text-gray-900 font-medium">
            ‚Üê Back to Session
        </a>
    </div>
</div>

<!-- Print Styles -->
<style>
    @@media print {
        body {
            print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
        }
        .print\:hidden {
            display: none !important;
        }
        .print\:block {
            display: block !important;
        }
    }
</style>
