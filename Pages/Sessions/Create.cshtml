@page
@model Gixat.Web.Pages.Sessions.CreateModel
@{
    ViewData["Title"] = "New Check-In";
    Layout = "_AppLayout";
}

<div class="max-w-2xl mx-auto animate-fade-in">
    <!-- Back Button -->
    <a href="/Sessions" class="inline-flex items-center gap-2 text-apple-gray hover:text-apple-dark mb-6 transition-colors">
        <i class="bi bi-arrow-left"></i>
        <span class="text-sm font-medium">Back to Sessions</span>
    </a>

    <!-- Form Card -->
    <div class="card-apple overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-apple-blue to-apple-indigo p-6 text-white">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                    <i class="bi bi-car-front text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-semibold">New Vehicle Check-In</h1>
                    <p class="text-white/80 text-sm">Start a new service session</p>
                </div>
            </div>
        </div>

        <!-- Form Body -->
        <div class="p-6">
            <form method="post">
                <div asp-validation-summary="All" class="bg-apple-red/10 border border-apple-red/20 text-apple-red px-4 py-3 rounded-apple mb-6 text-sm" role="alert"></div>

                <!-- Client Selection with Autocomplete -->
                @{
                    ViewData["InputId"] = "clientSelect";
                    ViewData["InputName"] = "SelectedClientId";
                    ViewData["Required"] = "True";
                    ViewData["Placeholder"] = "Search by name, phone, or email...";
                }
                <partial name="_ClientSearch" />

                <!-- Vehicle Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-apple-dark mb-2">
                        Select Vehicle <span class="text-apple-red">*</span>
                    </label>
                    <div class="relative">
                        <select asp-for="SelectedVehicleId" id="vehicleSelect" 
                                class="input-apple-outlined appearance-none pr-10 cursor-pointer disabled:bg-gray-50 disabled:text-apple-gray disabled:cursor-not-allowed" disabled>
                            <option value="">Choose a vehicle...</option>
                        </select>
                        <i class="bi bi-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-apple-gray pointer-events-none"></i>
                    </div>
                    <p class="mt-2 text-sm text-apple-gray" id="vehicleHelp">Select a client first to see their vehicles</p>
                </div>

                <!-- Divider -->
                <hr class="border-gray-100 my-6" />

                <!-- Mileage -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-apple-dark mb-2">
                        Mileage at Check-In
                    </label>
                    <div class="flex">
                        <input type="number" asp-for="MileageIn" placeholder="e.g., 45000" 
                               class="input-apple-outlined rounded-r-none border-r-0 flex-1" />
                        <span class="inline-flex items-center px-4 bg-gray-50 border border-gray-200 border-l-0 rounded-r-apple text-apple-gray text-sm font-medium">
                            km
                        </span>
                    </div>
                </div>

                <!-- Notes -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-apple-dark mb-2">
                        Initial Notes
                    </label>
                    <textarea asp-for="Notes" rows="3" placeholder="Any initial observations or customer comments..." 
                              class="input-apple-outlined resize-none"></textarea>
                </div>

                <!-- Actions -->
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
                    <a href="/Sessions" class="btn-apple-secondary">Cancel</a>
                    <button type="submit" class="btn-apple-primary">
                        <i class="bi bi-check-lg"></i>
                        Create Session
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // This script handles vehicle loading when client is selected
        // Note: The clientSelect is initialized by _ClientSearch.cshtml partial
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Tom Select to initialize, then hook into its onChange
            setTimeout(function() {
                const clientSelectElement = document.getElementById('clientSelect');
                if (clientSelectElement && clientSelectElement.tomselect) {
                    const originalOnChange = clientSelectElement.tomselect.on;
                    
                    clientSelectElement.tomselect.on('change', async function(clientId) {
                        const vehicleSelect = document.getElementById('vehicleSelect');
                        const vehicleHelp = document.getElementById('vehicleHelp');
                        
                        vehicleSelect.innerHTML = '<option value="">Choose a vehicle...</option>';
                        
                        if (!clientId) {
                            vehicleSelect.disabled = true;
                            vehicleHelp.textContent = 'Select a client first to see their vehicles';
                            return;
                        }
                        
                        try {
                            vehicleHelp.textContent = 'Loading vehicles...';
                            const response = await fetch(`/Sessions/Create?handler=Vehicles&clientId=${clientId}`);
                            const vehicles = await response.json();
                            
                            if (vehicles.length === 0) {
                                vehicleSelect.disabled = true;
                                vehicleHelp.innerHTML = 'No vehicles found. <a href="/Clients/' + clientId + '" class="text-apple-blue hover:text-apple-blue-hover font-medium">Add a vehicle â†’</a>';
                            } else {
                                vehicleSelect.disabled = false;
                                vehicleHelp.textContent = 'Select the vehicle being checked in';
                                
                                vehicles.forEach(vehicle => {
                                    const option = document.createElement('option');
                                    option.value = vehicle.id;
                                    option.textContent = vehicle.displayName;
                                    vehicleSelect.appendChild(option);
                                });
                            }
                        } catch (error) {
                            console.error('Error loading vehicles:', error);
                            vehicleHelp.textContent = 'Error loading vehicles. Please try again.';
                        }
                    });
                }
            }, 500); // Small delay to ensure Tom Select is initialized
        });
    </script>
}
