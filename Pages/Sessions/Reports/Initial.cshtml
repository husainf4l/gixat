@page "/Sessions/{id:guid}/Reports/Initial"
@model Gixat.Web.Pages.Sessions.Reports.InitialModel
@using Gixat.Web.Modules.Sessions.Enums
@{
    ViewData["Title"] = $"Initial Report - Session #{Model.Session.SessionNumber}";
    Layout = "_AppLayout";
}

<div class="max-w-7xl mx-auto animate-fade-in">
    <!-- Back Navigation -->
    <div class="print:hidden mb-6 animate-slide-up">
        <a href="/Sessions/Details/@Model.Session.Id" class="inline-flex items-center gap-2 text-slate-600 hover:text-slate-900 transition-colors group">
            <i class="bi bi-arrow-left group-hover:-translate-x-1 transition-transform"></i>
            <span class="text-sm font-medium">Back to Session Details</span>
        </a>
    </div>

    <!-- Header with Print Button -->
    <div class="print:hidden mb-6 animate-slide-up" style="animation-delay: 0.1s">
        <div class="relative overflow-hidden bg-gradient-to-br from-sky-50 via-cyan-50 to-blue-50 rounded-2xl border border-sky-100 shadow-sm">
            <!-- Decorative Elements -->
            <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-sky-400/10 to-cyan-400/10 rounded-full blur-3xl -mr-32 -mt-32"></div>
            <div class="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-tr from-blue-400/10 to-indigo-400/10 rounded-full blur-2xl -ml-24 -mb-24"></div>
            
            <div class="relative flex flex-col lg:flex-row lg:items-center justify-between gap-4 p-6">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-sky-500 to-sky-600 flex items-center justify-center text-white shadow-lg shadow-sky-500/30">
                            <i class="bi bi-file-earmark-text text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold bg-gradient-to-r from-slate-800 via-sky-700 to-sky-600 bg-clip-text text-transparent leading-tight">
                                Initial Inspection Report
                            </h1>
                            <p class="text-sm text-slate-600 mt-1">Session #@Model.Session.SessionNumber â€¢ @Model.Session.CheckInAt.ToString("MMM dd, yyyy")</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="window.print()" class="px-4 py-2.5 bg-gradient-to-r from-sky-600 to-sky-700 hover:from-sky-700 hover:to-sky-800 text-white rounded-xl font-medium transition-all duration-200 shadow-lg shadow-sky-600/30 hover:shadow-xl hover:shadow-sky-600/40 hover:-translate-y-0.5 flex items-center gap-2">
                        <i class="bi bi-printer"></i>
                        <span>Print Report</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

<div class="space-y-6 max-w-4xl mx-auto">

    <!-- Report Content -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 print:shadow-none print:border-0 animate-slide-up" style="animation-delay: 0.2s">
        <!-- Report Header -->
        <div class="border-b border-slate-200 pb-6 mb-6">
            <div class="flex justify-between items-start">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-12 h-12 bg-gradient-to-br from-sky-500 to-sky-600 rounded-xl flex items-center justify-center shadow-lg shadow-sky-500/30">
                            <i class="bi bi-file-earmark-medical text-white text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">Vehicle Initial Assessment Report</h2>
                            <p class="text-sm text-slate-600">Generated on @DateTime.Now.ToString("MMMM dd, yyyy HH:mm")</p>
                        </div>
                    </div>
                </div>
                <div class="text-right bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl px-4 py-3 border border-slate-200">
                    <p class="text-sm font-semibold text-slate-800">Session #@Model.Session.SessionNumber</p>
                    <p class="text-sm text-slate-600">@Model.Session.CheckInAt.ToString("MMM dd, yyyy")</p>
                </div>
            </div>
        </div>

        <!-- Client & Vehicle Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="relative overflow-hidden bg-gradient-to-br from-sky-50 to-blue-50 rounded-xl p-5 border border-sky-100">
                <div class="absolute top-0 right-0 w-24 h-24 bg-sky-500/10 rounded-full blur-2xl"></div>
                <h3 class="relative text-xs font-semibold text-sky-700 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="bi bi-person-circle"></i> Client Information
                </h3>
                <div class="relative space-y-2.5">
                    <p class="text-lg font-semibold text-slate-800">@Model.Client?.FirstName @Model.Client?.LastName</p>
                    @if (!string.IsNullOrEmpty(Model.Client?.Phone))
                    {
                        <p class="text-sm text-slate-600 flex items-center gap-2">
                            <i class="bi bi-telephone"></i> @Model.Client.Phone
                        </p>
                    }
                    @if (!string.IsNullOrEmpty(Model.Client?.Email))
                    {
                        <p class="text-sm text-slate-600 flex items-center gap-2">
                            <i class="bi bi-envelope"></i> @Model.Client.Email
                        </p>
                    }
                </div>
            </div>
            <div class="relative overflow-hidden bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-5 border border-indigo-100">
                <div class="absolute top-0 right-0 w-24 h-24 bg-indigo-500/10 rounded-full blur-2xl"></div>
                <h3 class="relative text-xs font-semibold text-indigo-700 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="bi bi-car-front-fill"></i> Vehicle Information
                </h3>
                <div class="relative space-y-2.5">
                    <p class="text-lg font-semibold text-slate-800">@Model.Vehicle?.Year @Model.Vehicle?.Make @Model.Vehicle?.Model</p>
                    @if (!string.IsNullOrEmpty(Model.Vehicle?.LicensePlate))
                    {
                        <p class="text-sm text-slate-600 flex items-center gap-2">
                            <i class="bi bi-credit-card-2-front"></i> Plate: @Model.Vehicle.LicensePlate
                        </p>
                    }
                    @if (!string.IsNullOrEmpty(Model.Vehicle?.Vin))
                    {
                        <p class="text-sm text-slate-600 flex items-center gap-2">
                            <i class="bi bi-upc"></i> VIN: @Model.Vehicle.Vin
                        </p>
                    }
                    @if (Model.Session.MileageIn.HasValue)
                    {
                        <p class="text-sm text-slate-600 flex items-center gap-2">
                            <i class="bi bi-speedometer2"></i> Mileage: @Model.Session.MileageIn.Value.ToString("N0") km
                        </p>
                    }
                </div>
            </div>
        </div>

        <!-- Customer Request -->
        @if (Model.CustomerRequest != null)
        {
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-apple-dark mb-4 flex items-center gap-3">
                    <span class="w-10 h-10 bg-gradient-to-br from-apple-blue/10 to-apple-indigo/10 rounded-xl flex items-center justify-center">
                        <i class="bi bi-chat-left-text text-apple-blue"></i>
                    </span>
                    Customer Request
                </h3>
                <div class="bg-gray-50 rounded-2xl p-5 space-y-4">
                    <div>
                        <p class="text-xs font-semibold text-apple-gray uppercase tracking-wider mb-2">Concerns</p>
                        <p class="text-apple-dark">@(Model.CustomerRequest.CustomerConcerns ?? "No specific concerns noted")</p>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.CustomerRequest.RequestedServices))
                    {
                        <div>
                            <p class="text-xs font-semibold text-apple-gray uppercase tracking-wider mb-2">Requested Services</p>
                            <p class="text-apple-dark">@Model.CustomerRequest.RequestedServices</p>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.CustomerRequest.Description))
                    {
                        <div>
                            <p class="text-xs font-semibold text-apple-gray uppercase tracking-wider mb-2">Additional Details</p>
                            <p class="text-apple-dark">@Model.CustomerRequest.Description</p>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Inspection Findings -->
        @if (Model.Inspection != null)
        {
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-apple-dark mb-4 flex items-center gap-3">
                    <span class="w-10 h-10 bg-gradient-to-br from-apple-orange/10 to-amber-100 rounded-xl flex items-center justify-center">
                        <i class="bi bi-clipboard-check text-apple-orange"></i>
                    </span>
                    Inspection Findings
                </h3>
                
                <!-- Condition Summary -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    @{
                        var conditions = new[] {
                            ("Engine", Model.Inspection.EngineCondition, "bi-gear-wide-connected"),
                            ("Transmission", Model.Inspection.TransmissionCondition, "bi-gear"),
                            ("Brakes", Model.Inspection.BrakeCondition, "bi-disc"),
                            ("Suspension", Model.Inspection.SuspensionCondition, "bi-arrows-expand"),
                            ("Tires", Model.Inspection.TireCondition, "bi-circle"),
                            ("Electrical", Model.Inspection.ElectricalCondition, "bi-lightning"),
                            ("Exterior", Model.Inspection.ExteriorCondition, "bi-car-front"),
                            ("Interior", Model.Inspection.InteriorCondition, "bi-door-open")
                        };
                    }
                    @foreach (var (name, condition, icon) in conditions)
                    {
                        if (!string.IsNullOrEmpty(condition))
                        {
                            var conditionConfig = condition.ToLower() switch
                            {
                                "good" or "excellent" => ("bg-apple-green/10 text-apple-green border-apple-green/20", "bi-check-circle"),
                                "fair" or "average" => ("bg-apple-orange/10 text-apple-orange border-apple-orange/20", "bi-exclamation-circle"),
                                "poor" or "bad" or "needs attention" => ("bg-apple-red/10 text-apple-red border-apple-red/20", "bi-x-circle"),
                                _ => ("bg-gray-100 text-apple-gray border-gray-200", "bi-dash-circle")
                            };
                            <div class="p-4 rounded-xl border @conditionConfig.Item1">
                                <div class="flex items-center gap-2 mb-1">
                                    <i class="bi @icon text-sm"></i>
                                    <p class="text-xs font-medium opacity-75">@name</p>
                                </div>
                                <p class="text-sm font-semibold flex items-center gap-1">
                                    <i class="bi @conditionConfig.Item2"></i>
                                    @condition
                                </p>
                            </div>
                        }
                    }
                </div>

                <!-- Inspection Items -->
                @if (Model.Inspection.Items?.Any() == true)
                {
                    <div class="bg-gray-50 rounded-2xl p-5 mb-4">
                        <p class="text-xs font-semibold text-apple-gray uppercase tracking-wider mb-4">Inspection Items</p>
                        <div class="space-y-3">
                            @foreach (var item in Model.Inspection.Items.OrderBy(i => i.SortOrder))
                            {
                                var priorityConfig = item.Priority switch
                                {
                                    Priority.Urgent => "text-apple-red",
                                    Priority.High => "text-apple-orange",
                                    Priority.Normal => "text-apple-blue",
                                    _ => "text-apple-gray"
                                };
                                var attentionIcon = item.RequiresAttention ? "bi-exclamation-triangle-fill text-apple-orange" : "bi-check-circle-fill text-apple-green";
                                
                                <div class="flex items-start gap-3 py-3 border-b border-gray-200 last:border-0">
                                    <i class="bi @attentionIcon text-lg mt-0.5"></i>
                                    <div class="flex-1">
                                        <p class="font-medium text-apple-dark">@item.ItemName</p>
                                        @if (!string.IsNullOrEmpty(item.Description))
                                        {
                                            <p class="text-sm text-apple-gray mt-0.5">@item.Description</p>
                                        }
                                        @if (!string.IsNullOrEmpty(item.Notes))
                                        {
                                            <p class="text-sm text-apple-gray italic mt-0.5">@item.Notes</p>
                                        }
                                    </div>
                                    <div class="text-right">
                                        <span class="text-xs font-medium @priorityConfig px-2 py-1 rounded-lg bg-white">@item.Priority</span>
                                        @if (!string.IsNullOrEmpty(item.Condition))
                                        {
                                            <p class="text-xs text-apple-gray mt-1">@item.Condition</p>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.Inspection.Findings))
                {
                    <div class="bg-gradient-to-r from-apple-orange/10 to-apple-orange/5 border border-apple-orange/20 rounded-xl p-5 mb-4">
                        <p class="text-sm font-semibold text-apple-orange mb-2 flex items-center gap-2">
                            <i class="bi bi-exclamation-triangle"></i> Key Findings
                        </p>
                        <p class="text-apple-dark">@Model.Inspection.Findings</p>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.Inspection.Recommendations))
                {
                    <div class="bg-gradient-to-r from-apple-blue/10 to-apple-blue/5 border border-apple-blue/20 rounded-xl p-5">
                        <p class="text-sm font-semibold text-apple-blue mb-2 flex items-center gap-2">
                            <i class="bi bi-lightbulb"></i> Recommendations
                        </p>
                        <p class="text-apple-dark">@Model.Inspection.Recommendations</p>
                    </div>
                }
            </div>
        }

        <!-- Test Drive Results -->
        @if (Model.TestDrive != null)
        {
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-apple-dark mb-4 flex items-center gap-3">
                    <span class="w-10 h-10 bg-gradient-to-br from-apple-green/10 to-apple-teal/10 rounded-xl flex items-center justify-center">
                        <i class="bi bi-speedometer2 text-apple-green"></i>
                    </span>
                    Test Drive Results
                </h3>
                
                @if (Model.TestDrive.MileageStart.HasValue && Model.TestDrive.MileageEnd.HasValue)
                {
                    <div class="flex gap-4 mb-6">
                        <div class="bg-gradient-to-br from-apple-green/10 to-apple-green/5 rounded-xl px-5 py-4 border border-apple-green/20">
                            <p class="text-xs text-apple-gray mb-1">Distance Driven</p>
                            <p class="text-2xl font-bold text-apple-green">@((Model.TestDrive.MileageEnd.Value - Model.TestDrive.MileageStart.Value).ToString("N0")) <span class="text-sm font-normal">km</span></p>
                        </div>
                        @if (Model.TestDrive.StartedAt.HasValue && Model.TestDrive.CompletedAt.HasValue)
                        {
                            <div class="bg-gradient-to-br from-apple-blue/10 to-apple-blue/5 rounded-xl px-5 py-4 border border-apple-blue/20">
                                <p class="text-xs text-apple-gray mb-1">Duration</p>
                                <p class="text-2xl font-bold text-apple-blue">@((Model.TestDrive.CompletedAt.Value - Model.TestDrive.StartedAt.Value).TotalMinutes.ToString("N0")) <span class="text-sm font-normal">min</span></p>
                            </div>
                        }
                    </div>
                }

                <!-- Performance Observations -->
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                    @{
                        var performances = new[] {
                            ("Engine", Model.TestDrive.EnginePerformance, "bi-gear-wide-connected"),
                            ("Transmission", Model.TestDrive.TransmissionPerformance, "bi-gear"),
                            ("Brakes", Model.TestDrive.BrakePerformance, "bi-disc"),
                            ("Steering", Model.TestDrive.SteeringPerformance, "bi-joystick"),
                            ("Suspension", Model.TestDrive.SuspensionPerformance, "bi-arrows-expand"),
                            ("A/C", Model.TestDrive.AcPerformance, "bi-snow2")
                        };
                    }
                    @foreach (var (name, performance, icon) in performances)
                    {
                        if (!string.IsNullOrEmpty(performance))
                        {
                            <div class="bg-gray-50 rounded-xl p-4">
                                <p class="text-xs font-medium text-apple-gray flex items-center gap-1.5 mb-1">
                                    <i class="bi @icon"></i> @name
                                </p>
                                <p class="text-sm text-apple-dark">@performance</p>
                            </div>
                        }
                    }
                </div>

                <!-- Observations -->
                @{
                    var observations = new[] {
                        ("Noise Observations", Model.TestDrive.NoiseObservations, "bi-volume-up"),
                        ("Vibration Observations", Model.TestDrive.VibrationObservations, "bi-activity"),
                        ("Electrical Observations", Model.TestDrive.ElectricalObservations, "bi-lightning")
                    };
                }
                @foreach (var (title, observation, icon) in observations)
                {
                    if (!string.IsNullOrEmpty(observation))
                    {
                        <div class="bg-gray-50 rounded-xl p-4 mb-2">
                            <p class="text-xs font-medium text-apple-gray flex items-center gap-1.5 mb-1">
                                <i class="bi @icon"></i> @title
                            </p>
                            <p class="text-sm text-apple-dark">@observation</p>
                        </div>
                    }
                }

                @if (!string.IsNullOrEmpty(Model.TestDrive.Findings))
                {
                    <div class="bg-gradient-to-r from-apple-orange/10 to-apple-orange/5 border border-apple-orange/20 rounded-xl p-5 mt-4 mb-4">
                        <p class="text-sm font-semibold text-apple-orange mb-2 flex items-center gap-2">
                            <i class="bi bi-exclamation-triangle"></i> Test Drive Findings
                        </p>
                        <p class="text-apple-dark">@Model.TestDrive.Findings</p>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.TestDrive.Recommendations))
                {
                    <div class="bg-gradient-to-r from-apple-blue/10 to-apple-blue/5 border border-apple-blue/20 rounded-xl p-5">
                        <p class="text-sm font-semibold text-apple-blue mb-2 flex items-center gap-2">
                            <i class="bi bi-lightbulb"></i> Recommendations
                        </p>
                        <p class="text-apple-dark">@Model.TestDrive.Recommendations</p>
                    </div>
                }
            </div>
        }

        <!-- Summary -->
        <div class="border-t border-gray-200 pt-6">
            <h3 class="text-lg font-semibold text-apple-dark mb-4">Summary</h3>
            <div class="bg-gradient-to-br from-gray-50 to-white rounded-2xl p-6 border border-gray-100">
                <div class="grid grid-cols-3 gap-6 text-center">
                    <div>
                        <div class="w-14 h-14 mx-auto mb-3 rounded-2xl flex items-center justify-center @(Model.CustomerRequest != null ? "bg-apple-blue/10" : "bg-gray-100")">
                            <i class="bi @(Model.CustomerRequest != null ? "bi-check-lg text-apple-blue" : "bi-dash text-gray-400") text-2xl"></i>
                        </div>
                        <p class="text-sm font-medium text-apple-dark">Customer Request</p>
                        <p class="text-xs text-apple-gray">@(Model.CustomerRequest != null ? "Completed" : "Not recorded")</p>
                    </div>
                    <div>
                        <div class="w-14 h-14 mx-auto mb-3 rounded-2xl flex items-center justify-center @(Model.Inspection != null ? "bg-apple-orange/10" : "bg-gray-100")">
                            <i class="bi @(Model.Inspection != null ? "bi-check-lg text-apple-orange" : "bi-dash text-gray-400") text-2xl"></i>
                        </div>
                        <p class="text-sm font-medium text-apple-dark">Inspection</p>
                        <p class="text-xs text-apple-gray">@(Model.Inspection != null ? "Completed" : "Not recorded")</p>
                    </div>
                    <div>
                        <div class="w-14 h-14 mx-auto mb-3 rounded-2xl flex items-center justify-center @(Model.TestDrive != null ? "bg-apple-green/10" : "bg-gray-100")">
                            <i class="bi @(Model.TestDrive != null ? "bi-check-lg text-apple-green" : "bi-dash text-gray-400") text-2xl"></i>
                        </div>
                        <p class="text-sm font-medium text-apple-dark">Test Drive</p>
                        <p class="text-xs text-apple-gray">@(Model.TestDrive != null ? "Completed" : "Not recorded")</p>
                    </div>
                </div>
                
                @if (Model.Inspection?.Items?.Any(i => i.RequiresAttention) == true)
                {
                    <div class="mt-6 pt-6 border-t border-gray-200 text-center">
                        <div class="inline-flex items-center gap-2 px-4 py-2 bg-apple-red/10 text-apple-red rounded-xl text-sm font-medium">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            @Model.Inspection.Items.Count(i => i.RequiresAttention) Items Requiring Attention
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Signature Area (for print) -->
        <div class="mt-10 pt-8 border-t border-gray-200 print:block hidden">
            <div class="grid grid-cols-2 gap-12">
                <div>
                    <p class="text-sm text-apple-gray mb-12">Customer Signature</p>
                    <div class="border-b-2 border-gray-300 w-full"></div>
                    <p class="text-xs text-apple-gray mt-2">Date: _______________</p>
                </div>
                <div>
                    <p class="text-sm text-apple-gray mb-12">Service Advisor Signature</p>
                    <div class="border-b-2 border-gray-300 w-full"></div>
                    <p class="text-xs text-apple-gray mt-2">Date: _______________</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Button (screen only) -->
    <div class="flex justify-start print:hidden animate-slide-up" style="animation-delay: 0.3s">
        <a href="/Sessions/Details/@Model.Session.Id" class="inline-flex items-center gap-2 px-4 py-2.5 bg-white hover:bg-slate-50 text-slate-700 rounded-xl font-medium transition-all duration-200 border border-slate-200 hover:border-slate-300 shadow-sm">
            <i class="bi bi-arrow-left"></i>
            <span>Back to Session</span>
        </a>
    </div>
</div>

<!-- Print Styles -->
<style>
    @@media print {
        body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
        .print\:hidden { display: none !important; }
        .print\:block { display: block !important; }
        .print\:shadow-none { box-shadow: none !important; }
        .print\:border-0 { border: none !important; }
        @@page { margin: 1.5cm; }
    }
    
    /* Enhanced animations */
    @@keyframes fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @@keyframes slide-up {
        from { 
            opacity: 0;
            transform: translateY(10px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-fade-in {
        animation: fade-in 0.5s ease-out;
    }
    
    .animate-slide-up {
        animation: slide-up 0.5s ease-out;
        animation-fill-mode: both;
</style>
