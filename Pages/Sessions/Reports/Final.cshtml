@page "/Sessions/{id:guid}/Reports/Final"
@model Gixat.Web.Pages.Sessions.Reports.FinalModel
@using Gixat.Web.Modules.Sessions.Enums
@{
    ViewData["Title"] = $"Final Report - Session #{Model.Session.SessionNumber}";
    Layout = "_AppLayout";
}

<!-- Decorative Background Elements -->
<div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none print:hidden">
    <div class="absolute top-0 right-0 w-96 h-96 bg-gradient-to-br from-green-500/10 to-emerald-500/5 rounded-full blur-3xl transform translate-x-1/2 -translate-y-1/2"></div>
    <div class="absolute bottom-0 left-0 w-96 h-96 bg-gradient-to-tr from-blue-500/10 to-indigo-500/5 rounded-full blur-3xl transform -translate-x-1/2 translate-y-1/2"></div>
</div>

<div class="space-y-6 max-w-4xl mx-auto animate-fade-in">
    <!-- Enhanced Header with Gradient -->
    <div class="print:hidden">
        <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-green-600 via-emerald-600 to-teal-600 p-8 shadow-xl animate-slide-up">
            <!-- Background Pattern -->
            <div class="absolute inset-0 opacity-10">
                <div class="absolute top-0 left-0 w-40 h-40 bg-white rounded-full blur-3xl"></div>
                <div class="absolute bottom-0 right-0 w-60 h-60 bg-white rounded-full blur-3xl"></div>
            </div>
            
            <div class="relative z-10 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="/Sessions/Details/@Model.Session.Id" class="w-12 h-12 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-xl flex items-center justify-center transition-all hover:scale-105">
                        <i class="bi bi-arrow-left text-white text-xl"></i>
                    </a>
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center shadow-lg">
                                <i class="bi bi-check-circle text-white text-2xl"></i>
                            </div>
                            <div>
                                <h1 class="text-3xl font-bold text-white drop-shadow-lg">Final Service Report</h1>
                                <p class="text-white/90 text-sm mt-1">Session #@Model.Session.SessionNumber</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button onclick="window.print()" class="px-6 py-3 bg-white text-green-600 rounded-xl font-semibold hover:bg-green-50 transition-all shadow-lg hover:shadow-xl hover:scale-105 flex items-center gap-2">
                    <i class="bi bi-printer"></i> Print Report
                </button>
            </div>
        </div>
    </div>

    <!-- Report Content -->
    <div class="card-apple p-8 print:shadow-none print:border-0 animate-slide-up shadow-xl" style="animation-delay: 0.1s">
        <!-- Report Header -->
        <div class="border-b border-gray-200 pb-6 mb-6">
            <div class="flex justify-between items-start">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center shadow-lg">
                            <i class="bi bi-check-circle text-white text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-apple-dark">Service Completion Report</h2>
                            <p class="text-sm text-apple-gray">Generated on @DateTime.Now.ToString("MMMM dd, yyyy HH:mm")</p>
                        </div>
                    </div>
                </div>
                <div class="text-right bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl px-5 py-3 border border-green-200 shadow-sm">
                    <p class="text-sm font-semibold text-apple-dark">Session #@Model.Session.SessionNumber</p>
                    <p class="text-xs text-apple-gray">@Model.Session.CheckInAt.ToString("MMM dd, yyyy") - @(Model.Session.CheckOutAt?.ToString("MMM dd, yyyy") ?? "Present")</p>
                </div>
            </div>
        </div>

        <!-- Client & Vehicle Info with Enhanced Gradients -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 animate-slide-up" style="animation-delay: 0.2s">
            <div class="bg-gradient-to-br from-sky-50 via-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-100 shadow-sm hover:shadow-lg transition-all">
                <h3 class="text-xs font-semibold text-sky-700 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="bi bi-person-circle text-lg"></i> Client Information
                </h3>
                <div class="space-y-3">
                    <p class="text-xl font-bold text-apple-dark">@Model.Client?.FirstName @Model.Client?.LastName</p>
                    @if (!string.IsNullOrEmpty(Model.Client?.Phone))
                    {
                        <p class="text-sm text-apple-gray flex items-center gap-2">
                            <i class="bi bi-telephone-fill text-sky-600"></i> @Model.Client.Phone
                        </p>
                    }
                    @if (!string.IsNullOrEmpty(Model.Client?.Email))
                    {
                        <p class="text-sm text-apple-gray flex items-center gap-2">
                            <i class="bi bi-envelope-fill text-sky-600"></i> @Model.Client.Email
                        </p>
                    }
                </div>
            </div>
            <div class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 rounded-2xl p-6 border border-purple-100 shadow-sm hover:shadow-lg transition-all">
                <h3 class="text-xs font-semibold text-indigo-700 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="bi bi-car-front-fill text-lg"></i> Vehicle Information
                </h3>
                <div class="space-y-3">
                    <p class="text-xl font-bold text-apple-dark">@Model.Vehicle?.Year @Model.Vehicle?.Make @Model.Vehicle?.Model</p>
                    @if (!string.IsNullOrEmpty(Model.Vehicle?.LicensePlate))
                    {
                        <p class="text-sm text-apple-gray flex items-center gap-2">
                            <i class="bi bi-credit-card-2-front-fill text-indigo-600"></i> Plate: @Model.Vehicle.LicensePlate
                        </p>
                    }
                    <div class="flex items-center gap-4 text-sm text-apple-gray pt-2 border-t border-purple-200 mt-3">
                        @if (Model.Session.MileageIn.HasValue)
                        {
                            <span class="flex items-center gap-1"><i class="bi bi-arrow-down-circle-fill text-indigo-600"></i> In: @Model.Session.MileageIn.Value.ToString("N0") km</span>
                        }
                        @if (Model.Session.MileageOut.HasValue)
                        {
                            <span class="flex items-center gap-1"><i class="bi bi-arrow-up-circle-fill text-purple-600"></i> Out: @Model.Session.MileageOut.Value.ToString("N0") km</span>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Summary -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-apple-dark mb-4 flex items-center gap-3">
                <span class="w-10 h-10 bg-gradient-to-br from-green-500/10 to-emerald-500/10 rounded-xl flex items-center justify-center">
                    <i class="bi bi-clipboard-check text-green-600"></i>
                </span>
                Work Completed
            </h3>
            
            @if (Model.JobCard != null && Model.JobCard.Items?.Any() == true)
            {
                <div class="bg-gray-50 rounded-2xl p-5">
                    <div class="space-y-4">
                        @foreach (var item in Model.JobCard.Items.OrderBy(i => i.SortOrder))
                        {
                            <div class="bg-white rounded-xl p-4 border border-gray-200">
                                <div class="flex items-start justify-between gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <i class="bi bi-wrench text-apple-blue"></i>
                                            <h4 class="font-semibold text-apple-dark">@item.Title</h4>
                                        </div>
                                        @if (!string.IsNullOrEmpty(item.Description))
                                        {
                                            <p class="text-sm text-apple-gray mb-2">@item.Description</p>
                                        }
                                        <div class="flex items-center gap-4 text-xs text-apple-gray">
                                            @if (item.EstimatedHours > 0)
                                            {
                                                <span><i class="bi bi-clock"></i> @item.EstimatedHours.ToString("N1") hrs</span>
                                            }
                                            @if (item.ActualHours > 0)
                                            {
                                                <span><i class="bi bi-check-circle text-green-600"></i> Actual: @item.ActualHours.ToString("N1") hrs</span>
                                            }
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-apple-gray">@item.Status</p>
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(item.TechnicianNotes))
                                {
                                    <div class="mt-3 pt-3 border-t border-gray-100">
                                        <p class="text-xs text-apple-gray"><i class="bi bi-info-circle"></i> @item.TechnicianNotes</p>
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <!-- Job Card Summary -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            @if (Model.JobCard.EstimatedHours > 0)
                            {
                                <div class="text-center p-3 bg-white rounded-lg">
                                    <p class="text-xs text-apple-gray mb-1">Estimated Hours</p>
                                    <p class="text-lg font-bold text-apple-dark">@Model.JobCard.EstimatedHours.ToString("N1")</p>
                                </div>
                            }
                            @if (Model.JobCard.ActualHours > 0)
                            {
                                <div class="text-center p-3 bg-white rounded-lg">
                                    <p class="text-xs text-apple-gray mb-1">Actual Hours</p>
                                    <p class="text-lg font-bold text-green-600">@Model.JobCard.ActualHours.ToString("N1")</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-5 text-center">
                    <i class="bi bi-exclamation-triangle text-yellow-600 text-2xl mb-2"></i>
                    <p class="text-sm text-yellow-800">No job card items found. Complete the job card to generate a full report.</p>
                </div>
            }
        </div>

        <!-- Initial Issues vs Final Status -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-apple-dark mb-4 flex items-center gap-3">
                <span class="w-10 h-10 bg-gradient-to-br from-apple-orange/10 to-amber-100 rounded-xl flex items-center justify-center">
                    <i class="bi bi-arrow-left-right text-apple-orange"></i>
                </span>
                Before & After
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Initial Request -->
                @if (Model.CustomerRequest != null)
                {
                    <div class="bg-gray-50 rounded-xl p-5 border border-gray-200">
                        <h4 class="text-sm font-semibold text-apple-gray uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i class="bi bi-chat-left-text"></i> Customer Concerns
                        </h4>
                        <p class="text-apple-dark">@(Model.CustomerRequest.CustomerConcerns ?? "No specific concerns noted")</p>
                        @if (!string.IsNullOrEmpty(Model.CustomerRequest.RequestedServices))
                        {
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <p class="text-xs text-apple-gray mb-1">Requested Services</p>
                                <p class="text-sm text-apple-dark">@Model.CustomerRequest.RequestedServices</p>
                            </div>
                        }
                    </div>
                }

                <!-- Final Status -->
                <div class="bg-green-50 rounded-xl p-5 border border-green-200">
                    <h4 class="text-sm font-semibold text-green-700 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <i class="bi bi-check-circle"></i> Resolution Status
                    </h4>
                    @if (Model.Session.Status == SessionStatus.Completed)
                    {
                        <div class="flex items-center gap-2 mb-2">
                            <i class="bi bi-check-circle-fill text-green-600 text-xl"></i>
                            <p class="font-semibold text-green-700">All services completed successfully</p>
                        </div>
                        @if (Model.Session.CheckOutAt.HasValue)
                        {
                            <p class="text-sm text-green-600">Completed on @Model.Session.CheckOutAt.Value.ToString("MMMM dd, yyyy")</p>
                        }
                    }
                    else
                    {
                        <p class="text-sm text-apple-gray">Session status: @Model.Session.Status</p>
                    }
                </div>
            </div>
        </div>

        <!-- Inspection Summary (if available) -->
        @if (Model.Inspection != null)
        {
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-apple-dark mb-4 flex items-center gap-3">
                    <span class="w-10 h-10 bg-gradient-to-br from-apple-blue/10 to-apple-indigo/10 rounded-xl flex items-center justify-center">
                        <i class="bi bi-clipboard-data text-apple-blue"></i>
                    </span>
                    Inspection Highlights
                </h3>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    @{
                        var conditions = new[] {
                            ("Engine", Model.Inspection.EngineCondition),
                            ("Transmission", Model.Inspection.TransmissionCondition),
                            ("Brakes", Model.Inspection.BrakeCondition),
                            ("Tires", Model.Inspection.TireCondition)
                        };
                    }
                    @foreach (var (name, condition) in conditions)
                    {
                        if (!string.IsNullOrEmpty(condition))
                        {
                            var conditionConfig = condition.ToLower() switch
                            {
                                "good" or "excellent" => ("bg-green-50 text-green-700 border-green-200", "bi-check-circle"),
                                "fair" or "average" => ("bg-yellow-50 text-yellow-700 border-yellow-200", "bi-exclamation-circle"),
                                "poor" or "bad" or "needs attention" => ("bg-red-50 text-red-700 border-red-200", "bi-x-circle"),
                                _ => ("bg-gray-50 text-apple-gray border-gray-200", "bi-dash-circle")
                            };
                            <div class="p-4 rounded-xl border @conditionConfig.Item1">
                                <p class="text-xs font-medium mb-1">@name</p>
                                <p class="text-sm font-semibold flex items-center gap-1">
                                    <i class="bi @conditionConfig.Item2"></i>
                                    @condition
                                </p>
                            </div>
                        }
                    }
                </div>

                @if (!string.IsNullOrEmpty(Model.Inspection.Recommendations))
                {
                    <div class="mt-4 bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <p class="text-sm font-semibold text-blue-700 mb-2 flex items-center gap-2">
                            <i class="bi bi-lightbulb"></i> Future Recommendations
                        </p>
                        <p class="text-sm text-blue-900">@Model.Inspection.Recommendations</p>
                    </div>
                }
            </div>
        }

        <!-- Test Drive (if performed) -->
        @if (Model.TestDrive != null)
        {
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-apple-dark mb-4 flex items-center gap-3">
                    <span class="w-10 h-10 bg-gradient-to-br from-purple-500/10 to-purple-600/10 rounded-xl flex items-center justify-center">
                        <i class="bi bi-speedometer2 text-purple-600"></i>
                    </span>
                    Test Drive Results
                </h3>
                
                <div class="bg-purple-50 border border-purple-200 rounded-xl p-5">
                    @if (!string.IsNullOrEmpty(Model.TestDrive.Findings))
                    {
                        <p class="text-apple-dark">@Model.TestDrive.Findings</p>
                    }
                    @if (Model.TestDrive.MileageStart.HasValue && Model.TestDrive.MileageEnd.HasValue)
                    {
                        <div class="mt-3 flex items-center gap-4 text-sm text-purple-700">
                            <span>Distance: @((Model.TestDrive.MileageEnd.Value - Model.TestDrive.MileageStart.Value).ToString("N0")) km</span>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Footer Notes -->
        <div class="border-t border-gray-200 pt-6 mt-8">
            <div class="bg-gradient-to-r from-apple-blue/5 to-transparent rounded-xl p-5 mb-4">
                <p class="text-xs font-semibold text-apple-gray uppercase tracking-wider mb-2">Service Notes</p>
                @if (!string.IsNullOrEmpty(Model.Session.Notes))
                {
                    <p class="text-sm text-apple-dark">@Model.Session.Notes</p>
                }
                else
                {
                    <p class="text-sm text-apple-gray italic">No additional notes provided.</p>
                }
            </div>

            <div class="text-center text-xs text-apple-gray pt-4 border-t border-gray-100">
                <p>This report was automatically generated on @DateTime.Now.ToString("MMMM dd, yyyy 'at' HH:mm")</p>
                <p class="mt-1">For questions or concerns, please contact your service advisor.</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        @@keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @@keyframes slide-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fade-in 0.6s ease-out;
        }
        
        .animate-slide-up {
            animation: slide-up 0.6s ease-out;
            animation-fill-mode: both;
        }
        
        @@media print {
            body { 
                background: white;
                padding: 20mm;
            }
            .print\:hidden { display: none !important; }
            .print\:shadow-none { box-shadow: none !important; }
            .print\:border-0 { border: 0 !important; }
            @@page {
                margin: 20mm;
            }
        }
    </style>
}
