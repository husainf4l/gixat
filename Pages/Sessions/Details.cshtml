@page "{id:guid}"
@model Gixat.Web.Pages.Sessions.DetailsModel
@using Gixat.Web.Modules.Sessions.Enums
@{
    ViewData["Title"] = "Session Details";
    Layout = "_AppLayout";
    
    var statusBadge = Model.Session!.Status switch
    {
        SessionStatus.CheckedIn => "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-primary-100 text-primary-700",
        SessionStatus.CustomerRequest => "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-indigo-100 text-indigo-700",
        SessionStatus.Inspection => "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-cyan-100 text-cyan-700",
        SessionStatus.TestDrive => "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-orange-100 text-orange-700",
        SessionStatus.AwaitingApproval => "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-700",
        SessionStatus.InProgress => "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-orange-100 text-orange-700",
        SessionStatus.Completed => "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700",
        SessionStatus.ReadyForPickup => "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-cyan-100 text-cyan-700",
        SessionStatus.Closed => "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-slate-100 text-slate-700",
        SessionStatus.Cancelled => "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700",
        _ => "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-slate-100 text-slate-700"
    };
}

<!-- Back Navigation -->
<a href="/Sessions" class="inline-flex items-center gap-2 text-slate-600 hover:text-primary-600 no-underline mb-6 text-sm transition-colors animate-fade-in">
    <i class="bi bi-arrow-left"></i>
    Back to Sessions
</a>

<!-- Header Card -->
<div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-8 animate-slide-up">
    <div class="bg-gradient-to-r from-primary-600 to-purple-600 p-6 text-white">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <h1 class="text-2xl font-semibold tracking-tight">Session #@Model.Session!.SessionNumber</h1>
                    <span class="bg-white/20 backdrop-blur px-3 py-1 rounded-full text-xs font-medium">
                        @Model.Session.Status.ToString().Replace("InProgress", "In Progress").Replace("AwaitingApproval", "Awaiting Approval").Replace("ReadyForPickup", "Ready for Pickup")
                    </span>
                </div>
                <div class="flex gap-4 text-sm opacity-90">
                    <span class="flex items-center gap-2">
                        <i class="bi bi-person"></i>@Model.Session.ClientName
                    </span>
                    <span class="flex items-center gap-2">
                        <i class="bi bi-car-front"></i>@Model.Session.VehicleDisplayName
                    </span>
                </div>
            </div>
            <div class="flex gap-3 flex-wrap">
                <div class="bg-white/15 backdrop-blur rounded-xl px-4 py-3 text-center min-w-[90px]">
                    <div class="text-lg font-bold">@Model.Session.MileageIn?.ToString("N0")</div>
                    <div class="text-[10px] uppercase tracking-wider opacity-80">Mileage In</div>
                </div>
                @if (Model.Session.CheckOutAt.HasValue)
                {
                    <div class="bg-white/15 backdrop-blur rounded-xl px-4 py-3 text-center min-w-[90px]">
                        <div class="text-lg font-bold">@Model.Session.MileageOut?.ToString("N0")</div>
                        <div class="text-[10px] uppercase tracking-wider opacity-80">Mileage Out</div>
                    </div>
                }
            </div>
        </div>
    </div>
    <div class="p-5 bg-gray-50/50">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <span class="block text-[10px] text-apple-gray uppercase tracking-wide mb-0.5">Check-In</span>
                <span class="text-sm font-medium text-apple-dark">@Model.Session.CheckInAt.ToString("MMM dd, yyyy • h:mm tt")</span>
            </div>
            @if (Model.Session.CheckOutAt.HasValue)
            {
                <div>
                    <span class="block text-[10px] text-slate-600 uppercase tracking-wide mb-0.5">Check-Out</span>
                    <span class="text-sm font-medium text-slate-900">@Model.Session.CheckOutAt.Value.ToString("MMM dd, yyyy • h:mm tt")</span>
                </div>
            }
            <div>
                <span class="block text-[10px] text-slate-600 uppercase tracking-wide mb-0.5">License Plate</span>
                <span class="text-sm font-medium text-slate-900">@Model.Session.VehicleLicensePlate</span>
            </div>
        </div>
    </div>
</div>

<!-- Workflow Progress -->
<div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-8 animate-slide-up" style="animation-delay: 0.1s;">
    <h2 class="text-lg font-semibold text-slate-900 mb-6 flex items-center gap-2">
        <i class="bi bi-diagram-3 text-primary-600"></i>Workflow Progress
    </h2>
    
    <div class="flex items-center justify-between relative px-4">
        <!-- Progress Line Background -->
        <div class="absolute top-6 left-[10%] right-[10%] h-1 bg-gray-200 rounded-full z-0"></div>
        <!-- Progress Line Fill -->
        <div class="absolute top-6 left-[10%] h-1 bg-gradient-to-r from-apple-blue to-apple-green rounded-full z-0 transition-all duration-500" 
             style="width: calc(@(GetProgressWidth())% * 0.8);"></div>

        <!-- Step: Customer Request -->
        <div class="relative z-10 flex flex-col items-center flex-1">
            <div class="w-12 h-12 rounded-xl @(Model.CustomerRequest != null ? "bg-green-600 text-white" : "bg-gray-200 text-slate-600") flex items-center justify-center shadow-sm transition-all">
                @if (Model.CustomerRequest != null)
                {
                    <i class="bi bi-check-lg text-lg"></i>
                }
                else
                {
                    <i class="bi bi-chat-left-text"></i>
                }
            </div>
            <span class="mt-3 text-xs font-medium @(Model.CustomerRequest != null ? "text-green-600" : "text-slate-600") text-center">Customer<br/>Request</span>
        </div>

        <!-- Step: Inspection -->
        <div class="relative z-10 flex flex-col items-center flex-1">
            <div class="w-12 h-12 rounded-xl @(Model.Inspection != null ? "bg-green-600 text-white" : "bg-gray-200 text-slate-600") flex items-center justify-center shadow-sm transition-all">
                @if (Model.Inspection != null)
                {
                    <i class="bi bi-check-lg text-lg"></i>
                }
                else
                {
                    <i class="bi bi-search"></i>
                }
            </div>
            <span class="mt-3 text-xs font-medium @(Model.Inspection != null ? "text-green-600" : "text-slate-600") text-center">Inspection</span>
        </div>

        <!-- Step: Test Drive -->
        <div class="relative z-10 flex flex-col items-center flex-1">
            <div class="w-12 h-12 rounded-xl @(Model.TestDrive != null ? "bg-green-600 text-white" : "bg-gray-200 text-slate-600") flex items-center justify-center shadow-sm transition-all">
                @if (Model.TestDrive != null)
                {
                    <i class="bi bi-check-lg text-lg"></i>
                }
                else
                {
                    <i class="bi bi-speedometer2"></i>
                }
            </div>
            <span class="mt-3 text-xs font-medium @(Model.TestDrive != null ? "text-green-600" : "text-slate-600") text-center">Test Drive</span>
        </div>

        <!-- Step: Job Card -->
        <div class="relative z-10 flex flex-col items-center flex-1">
            <div class="w-12 h-12 rounded-xl @(Model.JobCard != null ? "bg-green-600 text-white" : "bg-gray-200 text-slate-600") flex items-center justify-center shadow-sm transition-all">
                @if (Model.JobCard != null)
                {
                    <i class="bi bi-check-lg text-lg"></i>
                }
                else
                {
                    <i class="bi bi-card-checklist"></i>
                }
            </div>
            <span class="mt-3 text-xs font-medium @(Model.JobCard != null ? "text-green-600" : "text-slate-600") text-center">Job Card</span>
        </div>
    </div>
</div>

<!-- Workflow Module Cards -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-8 animate-slide-up" style="animation-delay: 0.15s;">
    <!-- Customer Request Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 hover:shadow-lg transition-all">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl @(Model.CustomerRequest != null ? "bg-green-100 text-green-600" : "bg-gray-100 text-slate-600") flex items-center justify-center">
                    <i class="bi bi-chat-left-text"></i>
                </div>
                <h3 class="font-semibold text-slate-900">Customer Request</h3>
            </div>
            @if (Model.CustomerRequest == null)
            {
                <a href="/Sessions/@Model.Session.Id/CustomerRequest/Create" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 text-sm font-semibold rounded-lg bg-primary-600 text-white hover:bg-primary-700 transition-colors text-sm py-2 px-3">
                    <i class="bi bi-plus-lg"></i>Add
                </a>
            }
            else
            {
                <a href="/Sessions/@Model.Session.Id/CustomerRequest" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-medium rounded-lg text-slate-700 hover:bg-slate-100 transition-colors text-sm py-2 px-3">
                    View <i class="bi bi-arrow-right"></i>
                </a>
            }
        </div>
        @if (Model.CustomerRequest != null)
        {
            <div class="space-y-2.5">
                <div class="flex items-center justify-between text-sm">
                    <span class="text-slate-600">Title</span>
                    <span class="font-medium text-slate-900">@Model.CustomerRequest.Title</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <span class="text-slate-600">Priority</span>
                    <span class="@(Model.CustomerRequest.Priority == Priority.High || Model.CustomerRequest.Priority == Priority.Urgent ? "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700" : Model.CustomerRequest.Priority == Priority.Normal ? "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-orange-100 text-orange-700" : "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700") text-xs">
                        @Model.CustomerRequest.Priority
                    </span>
                </div>
                @if (!string.IsNullOrEmpty(Model.CustomerRequest.Description))
                {
                    <p class="text-sm text-slate-600 mt-2 line-clamp-2">@Model.CustomerRequest.Description</p>
                }
            </div>
        }
        else
        {
            <p class="text-sm text-slate-600">No customer request recorded yet.</p>
        }
    </div>

    <!-- Inspection Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 hover:shadow-lg transition-all">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl @(Model.Inspection != null ? "bg-green-100 text-green-600" : "bg-gray-100 text-slate-600") flex items-center justify-center">
                    <i class="bi bi-search"></i>
                </div>
                <h3 class="font-semibold text-slate-900">Inspection</h3>
            </div>
            @if (Model.Inspection == null && Model.CustomerRequest != null)
            {
                <a href="/Sessions/@Model.Session.Id/Inspection/Create" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 text-sm font-semibold rounded-lg bg-primary-600 text-white hover:bg-primary-700 transition-colors text-sm py-2 px-3">
                    <i class="bi bi-plus-lg"></i>Start
                </a>
            }
            else if (Model.Inspection != null)
            {
                <a href="/Sessions/@Model.Session.Id/Inspection" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-medium rounded-lg text-slate-700 hover:bg-slate-100 transition-colors text-sm py-2 px-3">
                    View <i class="bi bi-arrow-right"></i>
                </a>
            }
        </div>
        @if (Model.Inspection != null)
        {
            <div class="space-y-2.5">
                <div class="flex items-center justify-between text-sm">
                    <span class="text-slate-600">Status</span>
                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-primary-100 text-primary-700 text-xs">@Model.Inspection.Status</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <span class="text-slate-600">Title</span>
                    <span class="font-medium text-slate-900">@Model.Inspection.Title</span>
                </div>
                @if (Model.Inspection.InspectionStartedAt.HasValue)
                {
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-slate-600">Started</span>
                        <span class="font-medium text-slate-900">@Model.Inspection.InspectionStartedAt.Value.ToString("MMM dd, yyyy")</span>
                    </div>
                }
            </div>
        }
        else if (Model.CustomerRequest == null)
        {
            <p class="text-sm text-slate-600">Complete customer request first.</p>
        }
        else
        {
            <p class="text-sm text-slate-600">No inspection recorded yet.</p>
        }
    </div>

    <!-- Test Drive Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 hover:shadow-lg transition-all">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl @(Model.TestDrive != null ? "bg-green-100 text-green-600" : "bg-gray-100 text-slate-600") flex items-center justify-center">
                    <i class="bi bi-speedometer2"></i>
                </div>
                <h3 class="font-semibold text-slate-900">Test Drive</h3>
            </div>
            @if (Model.TestDrive == null && Model.Inspection != null)
            {
                <a href="/Sessions/@Model.Session.Id/TestDrive/Create" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 text-sm font-semibold rounded-lg bg-primary-600 text-white hover:bg-primary-700 transition-colors text-sm py-2 px-3">
                    <i class="bi bi-plus-lg"></i>Record
                </a>
            }
            else if (Model.TestDrive != null)
            {
                <a href="/Sessions/@Model.Session.Id/TestDrive" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-medium rounded-lg text-slate-700 hover:bg-slate-100 transition-colors text-sm py-2 px-3">
                    View <i class="bi bi-arrow-right"></i>
                </a>
            }
        </div>
        @if (Model.TestDrive != null)
        {
            <div class="space-y-2.5">
                <div class="flex items-center justify-between text-sm">
                    <span class="text-slate-600">Status</span>
                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-primary-100 text-primary-700 text-xs">@Model.TestDrive.Status</span>
                </div>
                @if (Model.TestDrive.MileageStart.HasValue && Model.TestDrive.MileageEnd.HasValue)
                {
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-slate-600">Distance</span>
                        <span class="font-medium text-slate-900">@((Model.TestDrive.MileageEnd.Value - Model.TestDrive.MileageStart.Value).ToString("N0")) km</span>
                    </div>
                }
                @if (Model.TestDrive.StartedAt.HasValue && Model.TestDrive.CompletedAt.HasValue)
                {
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-slate-600">Duration</span>
                        <span class="font-medium text-slate-900">@((Model.TestDrive.CompletedAt.Value - Model.TestDrive.StartedAt.Value).TotalMinutes.ToString("N0")) min</span>
                    </div>
                }
            </div>
        }
        else if (Model.Inspection == null)
        {
            <p class="text-sm text-slate-600">Complete inspection first.</p>
        }
        else
        {
            <p class="text-sm text-slate-600">No test drive recorded yet.</p>
        }
    </div>
</div>

<!-- Reports Section -->
<div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-8 animate-slide-up" style="animation-delay: 0.2s;">
    <h2 class="text-lg font-semibold text-slate-900 mb-5 flex items-center gap-2">
        <i class="bi bi-file-earmark-text text-primary-600"></i>Reports
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <a href="/Sessions/@Model.Session.Id/Reports/Initial" 
           class="flex items-center p-4 border border-gray-200 rounded-xl hover:border-primary-600 hover:bg-primary-100 transition-all group">
            <div class="w-12 h-12 bg-primary-600/10 rounded-xl flex items-center justify-center mr-4 group-hover:bg-primary-600/20 transition-colors">
                <i class="bi bi-file-earmark-text text-primary-600 text-xl"></i>
            </div>
            <div>
                <h4 class="font-medium text-slate-900">Initial Report</h4>
                <p class="text-sm text-slate-600">View check-in report</p>
            </div>
            <i class="bi bi-chevron-right text-slate-600 ml-auto"></i>
        </a>

        <a href="/Sessions/@Model.Session.Id/Reports/Final" 
           class="flex items-center p-4 border border-gray-200 rounded-xl transition-all group @(Model.Session.Status != SessionStatus.Completed ? "opacity-50 pointer-events-none" : "hover:border-green-600 hover:bg-green-100")">
            <div class="w-12 h-12 bg-green-600/10 rounded-xl flex items-center justify-center mr-4 group-hover:bg-green-600/20 transition-colors">
                <i class="bi bi-check-circle text-green-600 text-xl"></i>
            </div>
            <div>
                <h4 class="font-medium text-slate-900">Final Report</h4>
                <p class="text-sm text-slate-600">@(Model.Session.Status == SessionStatus.Completed ? "View completion report" : "Available after checkout")</p>
            </div>
            <i class="bi bi-chevron-right text-slate-600 ml-auto"></i>
        </a>
    </div>
</div>

<!-- Job Card Section -->
<div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-8 animate-slide-up" style="animation-delay: 0.25s;">
    <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-semibold text-slate-900 flex items-center gap-2">
            <i class="bi bi-card-checklist text-primary-600"></i>Job Card
        </h2>
        @if (Model.JobCard == null && Model.Inspection != null)
        {
            <a href="/Sessions/@Model.Session.Id/JobCard/Create" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 text-sm font-semibold rounded-lg bg-primary-600 text-white hover:bg-primary-700 transition-colors">
                <i class="bi bi-plus-lg"></i>Create Job Card
            </a>
        }
        else if (Model.JobCard != null)
        {
            <a href="/Sessions/@Model.Session.Id/JobCard" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-medium rounded-lg text-slate-700 hover:bg-slate-100 transition-colors">
                View Details <i class="bi bi-arrow-right"></i>
            </a>
        }
    </div>
    @if (Model.JobCard != null)
    {
        <div class="space-y-3">
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <span class="text-sm text-slate-600">Status</span>
                <span class="@(Model.JobCard.Status == JobCardStatus.Completed ? "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700" : Model.JobCard.Status == JobCardStatus.InProgress ? "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-primary-100 text-primary-700" : "inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-orange-100 text-orange-700")">
                    @Model.JobCard.Status
                </span>
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <span class="text-sm text-slate-600">Estimated Hours</span>
                <span class="font-medium text-slate-900">@Model.JobCard.EstimatedHours.ToString("N1") hrs</span>
            </div>
            @if (Model.JobCard.ActualHours > 0)
            {
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <span class="text-sm text-slate-600">Actual Hours</span>
                    <span class="font-medium text-slate-900">@Model.JobCard.ActualHours.ToString("N1") hrs</span>
                </div>
            }
        </div>
    }
    else if (Model.Inspection == null)
    {
        <div class="text-center py-8">
            <i class="bi bi-clipboard-x text-4xl text-gray-300 mb-3"></i>
            <p class="text-sm text-slate-600">Complete inspection first before creating a job card.</p>
        </div>
    }
    else
    {
        <div class="text-center py-8">
            <i class="bi bi-card-checklist text-4xl text-gray-300 mb-3"></i>
            <p class="text-sm text-slate-600">No job card created yet. Create one to start tracking work.</p>
        </div>
    }
</div>

<!-- Actions -->
<div class="flex flex-col sm:flex-row justify-between items-center gap-4 animate-slide-up" style="animation-delay: 0.25s;">
    <a href="/Sessions" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-medium rounded-lg text-slate-700 hover:bg-slate-100 transition-colors">
        <i class="bi bi-arrow-left"></i>Back to Sessions
    </a>
    @if (Model.Session.Status != SessionStatus.Completed && Model.Session.Status != SessionStatus.Cancelled)
    {
        <div class="flex gap-3">
            @if (Model.JobCard != null && Model.JobCard.Status == JobCardStatus.Completed)
            {
                <a href="/Sessions/@Model.Session.Id/Checkout" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 text-sm font-semibold rounded-lg bg-primary-600 text-white hover:bg-primary-700 transition-colors bg-green-600 hover:bg-green-600/90">
                    <i class="bi bi-check-circle"></i>
                    Complete & Check Out
                </a>
            }
            <form method="post" asp-page-handler="Cancel" class="inline">
                <button type="submit" 
                        class="px-5 py-2.5 bg-red-600/10 text-red-600 font-medium rounded-xl hover:bg-red-600/20 transition-colors inline-flex items-center gap-2"
                        onclick="return confirm('Are you sure you want to cancel this session?')">
                    <i class="bi bi-x-circle"></i>
                    Cancel Session
                </button>
            </form>
        </div>
    }
</div>

@functions {
    private int GetProgressWidth()
    {
        int completed = 0;
        if (Model.CustomerRequest != null) completed++;
        if (Model.Inspection != null) completed++;
        if (Model.TestDrive != null) completed++;
        if (Model.JobCard != null) completed++;
        
        return completed switch
        {
            0 => 0,
            1 => 25,
            2 => 50,
            3 => 75,
            4 => 100,
            _ => 0
        };
    }
}
