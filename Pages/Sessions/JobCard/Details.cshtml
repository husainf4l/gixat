@page "/Sessions/{id:guid}/JobCard"
@model Gixat.Web.Pages.Sessions.JobCard.DetailsModel
@using Gixat.Web.Modules.Sessions.Enums
@{
    ViewData["Title"] = $"Job Card - {Model.JobCard.JobCardNumber}";
    Layout = "_AppLayout";
}

<div class="space-y-6 animate-fade-in">
    <!-- Header with gradient -->
    @{
        var headerGradient = Model.JobCard.Status switch
        {
            JobCardStatus.Completed => "from-apple-green to-apple-teal",
            JobCardStatus.InProgress => "from-apple-blue to-apple-indigo",
            JobCardStatus.Approved => "from-apple-purple to-apple-indigo",
            JobCardStatus.Cancelled => "from-gray-500 to-gray-600",
            _ => "from-apple-indigo to-apple-purple"
        };
    }
    <div class="bg-gradient-to-r @headerGradient rounded-2xl p-6 animate-slide-up">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/Sessions/Details/@Model.Session.Id" class="w-10 h-10 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center hover:bg-white/30 transition-all">
                    <i class="bi bi-arrow-left text-white text-lg"></i>
                </a>
                <div>
                    <h1 class="text-2xl font-semibold text-white">Job Card #@Model.JobCard.JobCardNumber</h1>
                    <p class="text-white/80 text-sm mt-1">Session #@Model.Session.SessionNumber • @Model.Session.VehicleDisplayName</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                @{
                    var statusIcon = Model.JobCard.Status switch
                    {
                        JobCardStatus.Draft => "bi-file-earmark",
                        JobCardStatus.Pending => "bi-hourglass-split",
                        JobCardStatus.Approved => "bi-check-circle",
                        JobCardStatus.InProgress => "bi-arrow-repeat",
                        JobCardStatus.Completed => "bi-check-circle-fill",
                        JobCardStatus.Cancelled => "bi-x-circle",
                        _ => "bi-file-earmark"
                    };
                }
                <span class="px-4 py-2 bg-white/20 backdrop-blur-sm text-white rounded-xl text-sm font-medium flex items-center gap-2">
                    <i class="bi @statusIcon"></i>
                    @Model.JobCard.Status
                </span>
            </div>
        </div>
    </div>

    <!-- Job Card Info -->
    <div class="card-apple p-6 animate-slide-up" style="animation-delay: 0.1s">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 bg-gradient-to-br from-apple-indigo/10 to-apple-purple/10 rounded-xl flex items-center justify-center">
                <i class="bi bi-clipboard-data text-apple-indigo text-lg"></i>
            </div>
            <h2 class="text-lg font-semibold text-apple-dark">Job Card Details</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="space-y-1">
                <p class="text-sm text-apple-gray">Title</p>
                <p class="text-base font-medium text-apple-dark">@Model.JobCard.Title</p>
            </div>
            <div class="space-y-1">
                <p class="text-sm text-apple-gray">Priority</p>
                @{
                    var priorityConfig = Model.JobCard.Priority switch
                    {
                        Priority.Urgent => ("badge-apple-red", "bi-exclamation-lg"),
                        Priority.High => ("badge-apple-orange", "bi-arrow-up"),
                        Priority.Normal => ("badge-apple-blue", "bi-dash"),
                        _ => ("badge-apple-green", "bi-arrow-down")
                    };
                }
                <span class="@priorityConfig.Item1 inline-flex items-center gap-1.5">
                    <i class="bi @priorityConfig.Item2"></i>
                    @Model.JobCard.Priority
                </span>
            </div>
            <div class="space-y-1">
                <p class="text-sm text-apple-gray">Estimated Hours</p>
                <p class="text-base font-medium text-apple-dark">@Model.JobCard.EstimatedHours.ToString("N1") <span class="text-apple-gray font-normal">hours</span></p>
            </div>
            @if (!string.IsNullOrEmpty(Model.JobCard.Description))
            {
                <div class="md:col-span-3 space-y-1">
                    <p class="text-sm text-apple-gray">Description</p>
                    <p class="text-base text-apple-dark leading-relaxed">@Model.JobCard.Description</p>
                </div>
            }
            @if (Model.JobCard.ActualHours > 0)
            {
                <div class="space-y-1">
                    <p class="text-sm text-apple-gray">Actual Hours</p>
                    <p class="text-base font-medium text-apple-dark">@Model.JobCard.ActualHours.ToString("N1") <span class="text-apple-gray font-normal">hours</span></p>
                </div>
            }
            @if (Model.JobCard.ActualStartAt.HasValue)
            {
                <div class="space-y-1">
                    <p class="text-sm text-apple-gray">Started At</p>
                    <p class="text-base font-medium text-apple-dark">@Model.JobCard.ActualStartAt.Value.ToString("MMM dd, yyyy HH:mm")</p>
                </div>
            }
            @if (Model.JobCard.ActualCompletionAt.HasValue)
            {
                <div class="space-y-1">
                    <p class="text-sm text-apple-gray">Completed At</p>
                    <p class="text-base font-medium text-apple-dark">@Model.JobCard.ActualCompletionAt.Value.ToString("MMM dd, yyyy HH:mm")</p>
                </div>
            }
        </div>
    </div>

    <!-- Approval Status -->
    <div class="card-apple p-6 animate-slide-up" style="animation-delay: 0.2s">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 bg-gradient-to-br from-apple-green/10 to-apple-teal/10 rounded-xl flex items-center justify-center">
                <i class="bi bi-shield-check text-apple-green text-lg"></i>
            </div>
            <h2 class="text-lg font-semibold text-apple-dark">Approval & Authorization</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Internal Approval -->
            <div class="p-5 rounded-2xl transition-all @(Model.JobCard.IsApproved ? "bg-gradient-to-br from-apple-green/10 to-apple-green/5 border border-apple-green/20" : "bg-gray-50 border border-gray-200")">
                <div class="flex items-center gap-3 mb-3">
                    @if (Model.JobCard.IsApproved)
                    {
                        <div class="w-10 h-10 bg-apple-green/20 rounded-xl flex items-center justify-center">
                            <i class="bi bi-check-lg text-apple-green text-xl"></i>
                        </div>
                        <span class="font-semibold text-apple-green">Internal Approval</span>
                    }
                    else
                    {
                        <div class="w-10 h-10 bg-gray-200 rounded-xl flex items-center justify-center">
                            <i class="bi bi-hourglass-split text-apple-gray text-lg"></i>
                        </div>
                        <span class="font-medium text-apple-gray">Pending Approval</span>
                    }
                </div>
                @if (Model.JobCard.ApprovedAt.HasValue)
                {
                    <p class="text-sm text-apple-gray flex items-center gap-2">
                        <i class="bi bi-calendar-check"></i>
                        Approved on @Model.JobCard.ApprovedAt.Value.ToString("MMM dd, yyyy HH:mm")
                    </p>
                }
            </div>
            
            <!-- Customer Authorization -->
            <div class="p-5 rounded-2xl transition-all @(Model.JobCard.CustomerAuthorized ? "bg-gradient-to-br from-apple-blue/10 to-apple-blue/5 border border-apple-blue/20" : "bg-gray-50 border border-gray-200")">
                <div class="flex items-center gap-3 mb-3">
                    @if (Model.JobCard.CustomerAuthorized)
                    {
                        <div class="w-10 h-10 bg-apple-blue/20 rounded-xl flex items-center justify-center">
                            <i class="bi bi-person-check text-apple-blue text-xl"></i>
                        </div>
                        <span class="font-semibold text-apple-blue">Customer Authorized</span>
                    }
                    else
                    {
                        <div class="w-10 h-10 bg-gray-200 rounded-xl flex items-center justify-center">
                            <i class="bi bi-person-dash text-apple-gray text-lg"></i>
                        </div>
                        <span class="font-medium text-apple-gray">Awaiting Authorization</span>
                    }
                </div>
                @if (Model.JobCard.CustomerAuthorizedAt.HasValue)
                {
                    <p class="text-sm text-apple-gray flex items-center gap-2">
                        <i class="bi bi-calendar-check"></i>
                        @Model.JobCard.CustomerAuthorizationMethod • @Model.JobCard.CustomerAuthorizedAt.Value.ToString("MMM dd, yyyy HH:mm")
                    </p>
                }
            </div>
        </div>
    </div>

    <!-- Job Card Items -->
    <div class="card-apple p-6 animate-slide-up" style="animation-delay: 0.3s">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-apple-orange/10 to-amber-100 rounded-xl flex items-center justify-center">
                    <i class="bi bi-list-check text-apple-orange text-lg"></i>
                </div>
                <h2 class="text-lg font-semibold text-apple-dark">Work Items</h2>
            </div>
            @if (Model.JobCard.Status != JobCardStatus.Completed && Model.JobCard.Status != JobCardStatus.Cancelled)
            {
                <a href="/Sessions/@Model.Session.Id/JobCard/AddItem" class="btn-apple-primary">
                    <i class="bi bi-plus-lg mr-1"></i> Add Item
                </a>
            }
        </div>
        
        @if (Model.JobCard.Items.Any())
        {
            <div class="space-y-3">
                @foreach (var item in Model.JobCard.Items.OrderBy(i => i.SortOrder))
                {
                    var itemStatusConfig = item.Status switch
                    {
                        Gixat.Web.Modules.Sessions.Enums.TaskStatus.Pending => ("bg-gray-100 text-gray-700", "bi-circle"),
                        Gixat.Web.Modules.Sessions.Enums.TaskStatus.InProgress => ("bg-apple-blue/10 text-apple-blue", "bi-arrow-repeat"),
                        Gixat.Web.Modules.Sessions.Enums.TaskStatus.Completed => ("bg-apple-green/10 text-apple-green", "bi-check-circle-fill"),
                        Gixat.Web.Modules.Sessions.Enums.TaskStatus.Deferred => ("bg-apple-orange/10 text-apple-orange", "bi-pause-circle"),
                        Gixat.Web.Modules.Sessions.Enums.TaskStatus.Cancelled => ("bg-apple-red/10 text-apple-red", "bi-x-circle"),
                        _ => ("bg-gray-100 text-gray-700", "bi-circle")
                    };
                    
                    <div class="group p-4 border border-gray-200 rounded-xl hover:border-apple-indigo/30 hover:shadow-sm transition-all">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 flex-wrap">
                                    <h4 class="font-medium text-apple-dark">@item.Title</h4>
                                    <span class="px-2.5 py-1 text-xs font-medium rounded-lg @itemStatusConfig.Item1 flex items-center gap-1">
                                        <i class="bi @itemStatusConfig.Item2"></i>
                                        @item.Status
                                    </span>
                                    @if (item.QualityChecked)
                                    {
                                        <span class="px-2.5 py-1 text-xs font-medium rounded-lg bg-apple-purple/10 text-apple-purple flex items-center gap-1">
                                            <i class="bi bi-award"></i> QC Passed
                                        </span>
                                    }
                                </div>
                                @if (!string.IsNullOrEmpty(item.Description))
                                {
                                    <p class="text-sm text-apple-gray mt-2">@item.Description</p>
                                }
                                <div class="flex items-center gap-4 mt-3 text-sm text-apple-gray">
                                    @if (!string.IsNullOrEmpty(item.Category))
                                    {
                                        <span class="flex items-center gap-1.5">
                                            <i class="bi bi-tag"></i> @item.Category
                                        </span>
                                    }
                                    <span class="flex items-center gap-1.5">
                                        <i class="bi bi-clock"></i> Est: @item.EstimatedHours.ToString("N1") hrs
                                    </span>
                                    @if (item.ActualHours > 0)
                                    {
                                        <span class="flex items-center gap-1.5 text-apple-green">
                                            <i class="bi bi-clock-history"></i> Actual: @item.ActualHours.ToString("N1") hrs
                                        </span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center py-12">
                <div class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="bi bi-clipboard text-3xl text-gray-300"></i>
                </div>
                <p class="text-apple-gray font-medium">No work items added yet</p>
                <p class="text-sm text-gray-400 mt-1">Add work items to track the jobs to be performed</p>
            </div>
        }
    </div>

    <!-- Summary & Notes -->
    @if (!string.IsNullOrEmpty(Model.JobCard.WorkSummary) || !string.IsNullOrEmpty(Model.JobCard.TechnicianNotes))
    {
        <div class="card-apple p-6 animate-slide-up" style="animation-delay: 0.4s">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-gradient-to-br from-apple-teal/10 to-cyan-100 rounded-xl flex items-center justify-center">
                    <i class="bi bi-journal-text text-apple-teal text-lg"></i>
                </div>
                <h2 class="text-lg font-semibold text-apple-dark">Summary & Notes</h2>
            </div>
            <div class="space-y-4">
                @if (!string.IsNullOrEmpty(Model.JobCard.WorkSummary))
                {
                    <div class="p-4 bg-gray-50 rounded-xl">
                        <p class="text-sm font-medium text-apple-gray mb-2 flex items-center gap-2">
                            <i class="bi bi-file-text"></i> Work Summary
                        </p>
                        <p class="text-apple-dark leading-relaxed">@Model.JobCard.WorkSummary</p>
                    </div>
                }
                @if (!string.IsNullOrEmpty(Model.JobCard.TechnicianNotes))
                {
                    <div class="p-4 bg-apple-blue/5 border border-apple-blue/10 rounded-xl">
                        <p class="text-sm font-medium text-apple-blue mb-2 flex items-center gap-2">
                            <i class="bi bi-tools"></i> Technician Notes
                        </p>
                        <p class="text-apple-dark leading-relaxed">@Model.JobCard.TechnicianNotes</p>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Actions -->
    <div class="flex justify-between items-center animate-slide-up" style="animation-delay: 0.5s">
        <a href="/Sessions/Details/@Model.Session.Id" class="btn-apple-ghost">
            <i class="bi bi-arrow-left mr-2"></i> Back to Session
        </a>
        
        <div class="flex gap-3">
            @if (Model.JobCard.Status == JobCardStatus.Draft && !Model.JobCard.IsApproved)
            {
                <form method="post" asp-page-handler="Approve" class="inline">
                    <button type="submit" class="btn-apple-primary bg-gradient-to-r from-apple-blue to-apple-indigo">
                        <i class="bi bi-check-circle mr-2"></i> Approve Job Card
                    </button>
                </form>
            }
            @if (Model.JobCard.IsApproved && Model.JobCard.Status != JobCardStatus.InProgress && Model.JobCard.Status != JobCardStatus.Completed)
            {
                <form method="post" asp-page-handler="StartWork" class="inline">
                    <button type="submit" class="btn-apple-primary bg-gradient-to-r from-apple-indigo to-apple-purple">
                        <i class="bi bi-play-circle mr-2"></i> Start Work
                    </button>
                </form>
            }
            @if (Model.JobCard.Status == JobCardStatus.InProgress)
            {
                <form method="post" asp-page-handler="CompleteWork" class="inline">
                    <button type="submit" class="btn-apple-primary bg-gradient-to-r from-apple-green to-apple-teal"
                            onclick="return confirm('Mark all work as completed?')">
                        <i class="bi bi-check-all mr-2"></i> Complete Work
                    </button>
                </form>
            }
        </div>
    </div>
</div>
