@*
    Client Search Component - Simple Dropdown
    Usage: Include this partial in any form that needs client selection
    Example: <partial name="_ClientSearch" model="new { InputId = "clientSelect", InputName = "SelectedClientId", Required = true }" />
*@

@{
    var inputId = ViewData["InputId"]?.ToString() ?? "clientSelect";
    var inputName = ViewData["InputName"]?.ToString() ?? "SelectedClientId";
    var required = ViewData["Required"]?.ToString() == "True";
    var placeholder = ViewData["Placeholder"]?.ToString() ?? "Select a client...";
    var selectedClientId = ViewData["SelectedClientId"]?.ToString();
}

<div class="client-search-wrapper">
    <div class="flex items-center justify-between mb-2">
        <label for="@inputId" class="block text-sm font-medium text-apple-dark">
            Select Client @if (required) { <span class="text-apple-red">*</span> }
        </label>
        <button type="button" id="@(inputId)_refresh" class="text-sm text-blue-600 hover:text-blue-700 font-medium flex items-center gap-1 transition-colors">
            <i class="bi bi-arrow-clockwise"></i>
            <span>Refresh</span>
        </button>
    </div>
    
    <select id="@inputId" name="@inputName" 
            class="input-apple-outlined w-full"
            @(required ? "required" : "")>
        <option value="">@placeholder</option>
        <!-- Options will be loaded via JavaScript -->
    </select>
    
    <!-- Client Summary Card (appears after selection) -->
    <div id="@(inputId)_summary" class="hidden mt-3 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-apple border border-blue-100">
        <div class="flex items-start gap-3">
            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-apple-blue to-apple-indigo flex items-center justify-center text-white font-semibold text-lg flex-shrink-0">
                <span id="@(inputId)_initials">--</span>
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                    <h4 id="@(inputId)_name" class="font-semibold text-apple-dark">--</h4>
                    <span id="@(inputId)_vip_badge" class="hidden badge-apple-orange text-xs">
                        <i class="bi bi-star-fill"></i> VIP
                    </span>
                </div>
                <div class="text-sm text-apple-gray space-y-0.5">
                    <div class="flex items-center gap-2">
                        <i class="bi bi-telephone text-xs"></i>
                        <span id="@(inputId)_phone">--</span>
                    </div>
                    <div id="@(inputId)_email_container" class="hidden flex items-center gap-2">
                        <i class="bi bi-envelope text-xs"></i>
                        <span id="@(inputId)_email">--</span>
                    </div>
                    <div class="flex items-center gap-3 mt-2 text-xs">
                        <span>
                            <i class="bi bi-car-front"></i>
                            <span id="@(inputId)_vehicles">0</span> vehicle(s)
                        </span>
                        <span id="@(inputId)_last_visit_container" class="hidden">
                            <i class="bi bi-clock"></i>
                            Last visit: <span id="@(inputId)_last_visit">--</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <p class="mt-2 text-sm text-apple-gray">
        Can't find the client? <a href="/Clients" class="text-apple-blue hover:text-apple-blue-hover font-medium">Add new client â†’</a>
    </p>
</div>

<script>
(function() {
    console.log('[ClientSearch] Initializing simple dropdown for client selection...');
    const selectElement = document.getElementById('@inputId');
    const summaryCard = document.getElementById('@(inputId)_summary');
    const refreshButton = document.getElementById('@(inputId)_refresh');
    
    if (!selectElement) {
        console.error('[ClientSearch] Select element not found with ID:', '@inputId');
        return;
    }
    
    // Function to load clients
    function loadClients() {
        console.log('[ClientSearch] Loading all clients...');
        
        // Show loading state
        if (refreshButton) {
            refreshButton.disabled = true;
            refreshButton.querySelector('i').classList.add('animate-spin');
        }
        
        // Load all clients
        fetch('/Clients?handler=Search&term=', {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        })
            .then(response => {
                console.log('[ClientSearch] Response status:', response.status);
                console.log('[ClientSearch] Response headers:', response.headers);
                
                if (response.status === 401) {
                    console.error('[ClientSearch] Unauthorized - user not logged in');
                    alert('You need to be logged in to view clients. Please log in and try again.');
                    window.location.href = '/Auth/Login';
                    return Promise.reject('Unauthorized');
                }
                
                if (response.status === 400) {
                    console.error('[ClientSearch] No company found for user');
                    alert('No company found. Please complete the setup wizard.');
                    window.location.href = '/Setup/Company';
                    return Promise.reject('No company');
                }
                
                if (!response.ok) {
                    console.error('[ClientSearch] HTTP error:', response.status, response.statusText);
                    return response.text().then(text => {
                        console.error('[ClientSearch] Error response body:', text);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    });
                }
                
                return response.json();
            })
            .then(clients => {
                if (!clients) return; // Handle rejected promises
                
                console.log('[ClientSearch] Loaded clients:', clients);
                console.log('[ClientSearch] Number of clients:', clients.length);
                
                // Store current selection
                const currentValue = selectElement.value;
                
                // Clear existing options except the first placeholder
                while (selectElement.options.length > 1) {
                    selectElement.remove(1);
                }
                
                if (clients.length === 0) {
                    console.warn('[ClientSearch] No clients found!');
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No clients available - Add one first';
                    option.disabled = true;
                    selectElement.appendChild(option);
                    return;
                }
                
                // Add all clients to dropdown
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.fullName} - ${client.phone}`;
                    option.dataset.client = JSON.stringify(client);
                    selectElement.appendChild(option);
                    console.log('[ClientSearch] Added client:', client.fullName);
                });
                
                // Restore selection if it still exists
                if (currentValue) {
                    selectElement.value = currentValue;
                }
                
                console.log('[ClientSearch] Dropdown populated with', clients.length, 'clients');
                
                // Remove loading state
                if (refreshButton) {
                    refreshButton.disabled = false;
                    refreshButton.querySelector('i').classList.remove('animate-spin');
                }
            })
            .catch(error => {
                console.error('[ClientSearch] Error loading clients:', error);
                if (error !== 'Unauthorized' && error !== 'No company') {
                    alert('Failed to load clients: ' + error.message + '\n\nPlease check the browser console for details.');
                }
                
                // Remove loading state
                if (refreshButton) {
                    refreshButton.disabled = false;
                    refreshButton.querySelector('i').classList.remove('animate-spin');
                }
            });
    }
    
    // Initial load
    loadClients();
    
    // Refresh button click handler
    if (refreshButton) {
        refreshButton.addEventListener('click', function(e) {
            e.preventDefault();
            loadClients();
        });
    }
    
    // Handle selection change
    selectElement.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        console.log('[ClientSearch] Client selected:', selectedOption.value);
        
        if (!selectedOption.value || !selectedOption.dataset.client) {
            if (summaryCard) summaryCard.classList.add('hidden');
            return;
        }
        
        try {
            const client = JSON.parse(selectedOption.dataset.client);
            console.log('[ClientSearch] Client data:', client);
            updateSummaryCard(client);
        } catch (error) {
            console.error('[ClientSearch] Error parsing client data:', error);
        }
    });
    
    function updateSummaryCard(client) {
        if (!summaryCard) return;
        
        // Update initials
        const initials = client.fullName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        document.getElementById('@(inputId)_initials').textContent = initials;
        
        // Update name
        document.getElementById('@(inputId)_name').textContent = client.fullName;
        
        // Update phone
        document.getElementById('@(inputId)_phone').textContent = client.phone || '--';
        
        // Update email
        const emailContainer = document.getElementById('@(inputId)_email_container');
        if (client.email) {
            document.getElementById('@(inputId)_email').textContent = client.email;
            emailContainer.classList.remove('hidden');
        } else {
            emailContainer.classList.add('hidden');
        }
        
        // Update VIP badge
        const vipBadge = document.getElementById('@(inputId)_vip_badge');
        if (client.isVip) {
            vipBadge.classList.remove('hidden');
        } else {
            vipBadge.classList.add('hidden');
        }
        
        // Update vehicle count
        document.getElementById('@(inputId)_vehicles').textContent = client.vehicleCount || 0;
        
        // Update last visit
        const lastVisitContainer = document.getElementById('@(inputId)_last_visit_container');
        if (client.lastVisitAt) {
            const lastVisitDate = new Date(client.lastVisitAt).toLocaleDateString();
            document.getElementById('@(inputId)_last_visit').textContent = lastVisitDate;
            lastVisitContainer.classList.remove('hidden');
        } else {
            lastVisitContainer.classList.add('hidden');
        }
        
        // Show summary card
        summaryCard.classList.remove('hidden');
        
        console.log('[ClientSearch] Summary card updated');
    }
})();
</script>
